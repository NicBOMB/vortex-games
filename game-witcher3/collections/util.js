"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.hex2Buffer = exports.restoreFileData = exports.cleanUpEntries = exports.prepareFileData = exports.walkDirPath = exports.genCollectionLoadOrder = exports.isModInCollection = exports.isValidMod = exports.CollectionParseError = exports.CollectionGenerateError = void 0;
const path_1 = __importDefault(require("path"));
const shortid_1 = require("shortid");
const turbowalk_1 = __importDefault(require("turbowalk"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("../common");
class CollectionGenerateError extends Error {
    constructor(why) {
        super(`Failed to generate game specific data for collection: ${why}`);
        this.name = 'CollectionGenerateError';
    }
}
exports.CollectionGenerateError = CollectionGenerateError;
class CollectionParseError extends Error {
    constructor(collectionName, why) {
        super(`Failed to parse game specific data for collection ${collectionName}: ${why}`);
        this.name = 'CollectionGenerateError';
    }
}
exports.CollectionParseError = CollectionParseError;
function isValidMod(mod) {
    return (mod !== undefined) && (mod.type !== 'collection');
}
exports.isValidMod = isValidMod;
function isModInCollection(collectionMod, mod) {
    if (collectionMod.rules === undefined) {
        return false;
    }
    return collectionMod.rules.find(rule => vortex_api_1.util.testModReference(mod, rule.reference)) !== undefined;
}
exports.isModInCollection = isModInCollection;
function genCollectionLoadOrder(loadOrder, mods, collection) {
    const sortedMods = Object.keys(loadOrder)
        .filter(id => {
        const isLocked = id.toLowerCase().includes(common_1.LOCKED_PREFIX);
        return isLocked || ((collection !== undefined)
            ? isValidMod(mods[id]) && (isModInCollection(collection, mods[id]))
            : isValidMod(mods[id]));
    })
        .sort((lhs, rhs) => loadOrder[lhs].pos - loadOrder[rhs].pos)
        .reduce((accum, iter, idx) => {
        accum[iter] = {
            ...loadOrder[iter],
            pos: idx,
        };
        return accum;
    }, {});
    return sortedMods;
}
exports.genCollectionLoadOrder = genCollectionLoadOrder;
async function walkDirPath(dirPath) {
    let fileEntries = [];
    await (0, turbowalk_1.default)(dirPath, (entries) => {
        fileEntries = fileEntries.concat(entries);
    })
        .catch({ systemCode: 3 }, () => Promise.resolve())
        .catch(err => ['ENOTFOUND', 'ENOENT'].includes(err.code)
        ? Promise.resolve() : Promise.reject(err));
    return fileEntries;
}
exports.walkDirPath = walkDirPath;
async function prepareFileData(dirPath) {
    const sevenZip = new vortex_api_1.util.SevenZip();
    try {
        await vortex_api_1.fs.ensureDirWritableAsync(common_1.W3_TEMP_DATA_DIR);
        const archivePath = path_1.default.join(common_1.W3_TEMP_DATA_DIR, (0, shortid_1.generate)() + '.zip');
        const entries = await vortex_api_1.fs.readdirAsync(dirPath);
        await sevenZip.add(archivePath, entries.map(entry => path_1.default.join(dirPath, entry)), { raw: ['-r'] });
        const data = await vortex_api_1.fs.readFileAsync(archivePath);
        await vortex_api_1.fs.removeAsync(archivePath);
        return data;
    }
    catch (err) {
        return Promise.reject(err);
    }
}
exports.prepareFileData = prepareFileData;
async function cleanUpEntries(fileEntries) {
    try {
        fileEntries.sort((lhs, rhs) => rhs.filePath.length - lhs.filePath.length);
        for (const entry of fileEntries) {
            await vortex_api_1.fs.removeAsync(entry.filePath);
        }
    }
    catch (err) {
        (0, vortex_api_1.log)('error', 'file entry cleanup failed', err);
    }
}
exports.cleanUpEntries = cleanUpEntries;
async function restoreFileData(fileData, destination) {
    const sevenZip = new vortex_api_1.util.SevenZip();
    let archivePath;
    let fileEntries = [];
    try {
        await vortex_api_1.fs.ensureDirWritableAsync(common_1.W3_TEMP_DATA_DIR);
        archivePath = path_1.default.join(common_1.W3_TEMP_DATA_DIR, (0, shortid_1.generate)() + '.zip');
        await vortex_api_1.fs.writeFileAsync(archivePath, fileData);
        const targetDirPath = path_1.default.join(common_1.W3_TEMP_DATA_DIR, path_1.default.basename(archivePath, '.zip'));
        await sevenZip.extractFull(archivePath, targetDirPath);
        fileEntries = await walkDirPath(targetDirPath);
        for (const entry of fileEntries) {
            const relPath = path_1.default.relative(targetDirPath, entry.filePath);
            const dest = path_1.default.join(destination, relPath);
            await vortex_api_1.fs.ensureDirWritableAsync(path_1.default.dirname(dest));
            await vortex_api_1.fs.copyAsync(entry.filePath, dest);
        }
        cleanUpEntries(fileEntries);
        return Promise.resolve();
    }
    catch (err) {
        cleanUpEntries(fileEntries);
        return Promise.reject(err);
    }
}
exports.restoreFileData = restoreFileData;
function hex2Buffer(hexData) {
    const byteArray = new Uint8Array(hexData.length / 2);
    for (let x = 0; x < byteArray.length; x++) {
        byteArray[x] = parseInt(hexData.substr(x * 2, 2), 16);
    }
    const buffer = Buffer.from(byteArray);
    return buffer;
}
exports.hex2Buffer = hex2Buffer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZ0RBQXdCO0FBQ3hCLHFDQUFtQztBQUNuQywwREFBOEM7QUFDOUMsMkNBQWtEO0FBR2xELHNDQUE0RDtBQUU1RCxNQUFhLHVCQUF3QixTQUFRLEtBQUs7SUFDaEQsWUFBWSxHQUFXO1FBQ3JCLEtBQUssQ0FBQyx5REFBeUQsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsSUFBSSxHQUFHLHlCQUF5QixDQUFDO0lBQ3hDLENBQUM7Q0FDRjtBQUxELDBEQUtDO0FBRUQsTUFBYSxvQkFBcUIsU0FBUSxLQUFLO0lBQzdDLFlBQVksY0FBc0IsRUFBRSxHQUFXO1FBQzdDLEtBQUssQ0FBQyxxREFBcUQsY0FBYyxLQUFLLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDckYsSUFBSSxDQUFDLElBQUksR0FBRyx5QkFBeUIsQ0FBQztJQUN4QyxDQUFDO0NBQ0Y7QUFMRCxvREFLQztBQUVELFNBQWdCLFVBQVUsQ0FBQyxHQUFlO0lBQ3hDLE9BQU8sQ0FBQyxHQUFHLEtBQUssU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLFlBQVksQ0FBQyxDQUFDO0FBQzVELENBQUM7QUFGRCxnQ0FFQztBQUVELFNBQWdCLGlCQUFpQixDQUFDLGFBQXlCLEVBQUUsR0FBZTtJQUMxRSxJQUFJLGFBQWEsQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO1FBQ3JDLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFFRCxPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQ3JDLGlCQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQztBQUM5RCxDQUFDO0FBUEQsOENBT0M7QUFFRCxTQUFnQixzQkFBc0IsQ0FDcEMsU0FBK0MsRUFDL0MsSUFBcUMsRUFDckMsVUFBdUI7SUFFdkIsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7U0FDdEMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQ1gsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxzQkFBYSxDQUFDLENBQUM7UUFDMUQsT0FBTyxRQUFRLElBQUksQ0FBQyxDQUFDLFVBQVUsS0FBSyxTQUFTLENBQUM7WUFDNUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNuRSxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUIsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDO1NBQzNELE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDM0IsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHO1lBQ1osR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1lBQ2xCLEdBQUcsRUFBRSxHQUFHO1NBQ1QsQ0FBQztRQUNGLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ1QsT0FBTyxVQUFVLENBQUM7QUFDcEIsQ0FBQztBQXJCRCx3REFxQkM7QUFFTSxLQUFLLFVBQVUsV0FBVyxDQUFDLE9BQWU7SUFDL0MsSUFBSSxXQUFXLEdBQWEsRUFBRSxDQUFDO0lBQy9CLE1BQU0sSUFBQSxtQkFBUyxFQUFDLE9BQU8sRUFBRSxDQUFDLE9BQWlCLEVBQUUsRUFBRTtRQUM3QyxXQUFXLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUM7U0FDRCxLQUFLLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ2pELEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3RELENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUU3QyxPQUFPLFdBQVcsQ0FBQztBQUNyQixDQUFDO0FBVkQsa0NBVUM7QUFFTSxLQUFLLFVBQVUsZUFBZSxDQUFDLE9BQWU7SUFDbkQsTUFBTSxRQUFRLEdBQUcsSUFBSSxpQkFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3JDLElBQUk7UUFDRixNQUFNLGVBQUUsQ0FBQyxzQkFBc0IsQ0FBQyx5QkFBZ0IsQ0FBQyxDQUFDO1FBQ2xELE1BQU0sV0FBVyxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMseUJBQWdCLEVBQUUsSUFBQSxrQkFBUSxHQUFFLEdBQUcsTUFBTSxDQUFDLENBQUM7UUFDckUsTUFBTSxPQUFPLEdBQWEsTUFBTSxlQUFFLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3pELE1BQU0sUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUNsRCxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRS9DLE1BQU0sSUFBSSxHQUFHLE1BQU0sZUFBRSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqRCxNQUFNLGVBQUUsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDbEMsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1osT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQzVCO0FBQ0gsQ0FBQztBQWZELDBDQWVDO0FBRU0sS0FBSyxVQUFVLGNBQWMsQ0FBQyxXQUFxQjtJQUN4RCxJQUFJO1FBQ0YsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDMUUsS0FBSyxNQUFNLEtBQUssSUFBSSxXQUFXLEVBQUU7WUFDL0IsTUFBTSxlQUFFLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUN0QztLQUNGO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixJQUFBLGdCQUFHLEVBQUMsT0FBTyxFQUFFLDJCQUEyQixFQUFFLEdBQUcsQ0FBQyxDQUFDO0tBQ2hEO0FBQ0gsQ0FBQztBQVRELHdDQVNDO0FBRU0sS0FBSyxVQUFVLGVBQWUsQ0FBQyxRQUFnQixFQUFFLFdBQW1CO0lBQ3pFLE1BQU0sUUFBUSxHQUFHLElBQUksaUJBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNyQyxJQUFJLFdBQVcsQ0FBQztJQUNoQixJQUFJLFdBQVcsR0FBYSxFQUFFLENBQUM7SUFDL0IsSUFBSTtRQUNGLE1BQU0sZUFBRSxDQUFDLHNCQUFzQixDQUFDLHlCQUFnQixDQUFDLENBQUM7UUFDbEQsV0FBVyxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMseUJBQWdCLEVBQUUsSUFBQSxrQkFBUSxHQUFFLEdBQUcsTUFBTSxDQUFDLENBQUM7UUFDL0QsTUFBTSxlQUFFLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMvQyxNQUFNLGFBQWEsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLHlCQUFnQixFQUFFLGNBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDdEYsTUFBTSxRQUFRLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN2RCxXQUFXLEdBQUcsTUFBTSxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDL0MsS0FBSyxNQUFNLEtBQUssSUFBSSxXQUFXLEVBQUU7WUFDL0IsTUFBTSxPQUFPLEdBQUcsY0FBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzdELE1BQU0sSUFBSSxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzdDLE1BQU0sZUFBRSxDQUFDLHNCQUFzQixDQUFDLGNBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNwRCxNQUFNLGVBQUUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUMxQztRQUNELGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM1QixPQUFPLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUMxQjtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1osY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzVCLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUM1QjtBQUNILENBQUM7QUF2QkQsMENBdUJDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLE9BQWU7SUFDeEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNyRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUN6QyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztLQUN2RDtJQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdEMsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQVJELGdDQVFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBnZW5lcmF0ZSB9IGZyb20gJ3Nob3J0aWQnO1xuaW1wb3J0IHR1cmJvd2FsaywgeyBJRW50cnkgfSBmcm9tICd0dXJib3dhbGsnO1xuaW1wb3J0IHsgZnMsIGxvZywgdHlwZXMsIHV0aWwgfSBmcm9tICd2b3J0ZXgtYXBpJztcbmltcG9ydCB7IElMb2FkT3JkZXIsIElMb2FkT3JkZXJFbnRyeSB9IGZyb20gJy4vdHlwZXMnO1xuXG5pbXBvcnQgeyBMT0NLRURfUFJFRklYLCBXM19URU1QX0RBVEFfRElSIH0gZnJvbSAnLi4vY29tbW9uJztcblxuZXhwb3J0IGNsYXNzIENvbGxlY3Rpb25HZW5lcmF0ZUVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBjb25zdHJ1Y3Rvcih3aHk6IHN0cmluZykge1xuICAgIHN1cGVyKGBGYWlsZWQgdG8gZ2VuZXJhdGUgZ2FtZSBzcGVjaWZpYyBkYXRhIGZvciBjb2xsZWN0aW9uOiAke3doeX1gKTtcbiAgICB0aGlzLm5hbWUgPSAnQ29sbGVjdGlvbkdlbmVyYXRlRXJyb3InO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDb2xsZWN0aW9uUGFyc2VFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IoY29sbGVjdGlvbk5hbWU6IHN0cmluZywgd2h5OiBzdHJpbmcpIHtcbiAgICBzdXBlcihgRmFpbGVkIHRvIHBhcnNlIGdhbWUgc3BlY2lmaWMgZGF0YSBmb3IgY29sbGVjdGlvbiAke2NvbGxlY3Rpb25OYW1lfTogJHt3aHl9YCk7XG4gICAgdGhpcy5uYW1lID0gJ0NvbGxlY3Rpb25HZW5lcmF0ZUVycm9yJztcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNWYWxpZE1vZChtb2Q6IHR5cGVzLklNb2QpIHtcbiAgcmV0dXJuIChtb2QgIT09IHVuZGVmaW5lZCkgJiYgKG1vZC50eXBlICE9PSAnY29sbGVjdGlvbicpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNNb2RJbkNvbGxlY3Rpb24oY29sbGVjdGlvbk1vZDogdHlwZXMuSU1vZCwgbW9kOiB0eXBlcy5JTW9kKSB7XG4gIGlmIChjb2xsZWN0aW9uTW9kLnJ1bGVzID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gY29sbGVjdGlvbk1vZC5ydWxlcy5maW5kKHJ1bGUgPT5cbiAgICB1dGlsLnRlc3RNb2RSZWZlcmVuY2UobW9kLCBydWxlLnJlZmVyZW5jZSkpICE9PSB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5Db2xsZWN0aW9uTG9hZE9yZGVyKFxuICBsb2FkT3JkZXI6IHsgW21vZElkOiBzdHJpbmddOiBJTG9hZE9yZGVyRW50cnkgfSxcbiAgbW9kczogeyBbbW9kSWQ6IHN0cmluZ106IHR5cGVzLklNb2QgfSxcbiAgY29sbGVjdGlvbj86IHR5cGVzLklNb2Rcbik6IElMb2FkT3JkZXIge1xuICBjb25zdCBzb3J0ZWRNb2RzID0gT2JqZWN0LmtleXMobG9hZE9yZGVyKVxuICAgIC5maWx0ZXIoaWQgPT4ge1xuICAgICAgY29uc3QgaXNMb2NrZWQgPSBpZC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKExPQ0tFRF9QUkVGSVgpO1xuICAgICAgcmV0dXJuIGlzTG9ja2VkIHx8ICgoY29sbGVjdGlvbiAhPT0gdW5kZWZpbmVkKVxuICAgICAgICA/IGlzVmFsaWRNb2QobW9kc1tpZF0pICYmIChpc01vZEluQ29sbGVjdGlvbihjb2xsZWN0aW9uLCBtb2RzW2lkXSkpXG4gICAgICAgIDogaXNWYWxpZE1vZChtb2RzW2lkXSkpO1xuICAgIH0pXG4gICAgLnNvcnQoKGxocywgcmhzKSA9PiBsb2FkT3JkZXJbbGhzXS5wb3MgLSBsb2FkT3JkZXJbcmhzXS5wb3MpXG4gICAgLnJlZHVjZSgoYWNjdW0sIGl0ZXIsIGlkeCkgPT4ge1xuICAgICAgYWNjdW1baXRlcl0gPSB7XG4gICAgICAgIC4uLmxvYWRPcmRlcltpdGVyXSxcbiAgICAgICAgcG9zOiBpZHgsXG4gICAgICB9O1xuICAgICAgcmV0dXJuIGFjY3VtO1xuICAgIH0sIHt9KTtcbiAgcmV0dXJuIHNvcnRlZE1vZHM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3YWxrRGlyUGF0aChkaXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPElFbnRyeVtdPiB7XG4gIGxldCBmaWxlRW50cmllczogSUVudHJ5W10gPSBbXTtcbiAgYXdhaXQgdHVyYm93YWxrKGRpclBhdGgsIChlbnRyaWVzOiBJRW50cnlbXSkgPT4ge1xuICAgIGZpbGVFbnRyaWVzID0gZmlsZUVudHJpZXMuY29uY2F0KGVudHJpZXMpO1xuICB9KVxuICAuY2F0Y2goeyBzeXN0ZW1Db2RlOiAzIH0sICgpID0+IFByb21pc2UucmVzb2x2ZSgpKVxuICAuY2F0Y2goZXJyID0+IFsnRU5PVEZPVU5EJywgJ0VOT0VOVCddLmluY2x1ZGVzKGVyci5jb2RlKVxuICAgID8gUHJvbWlzZS5yZXNvbHZlKCkgOiBQcm9taXNlLnJlamVjdChlcnIpKTtcblxuICByZXR1cm4gZmlsZUVudHJpZXM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcmVwYXJlRmlsZURhdGEoZGlyUGF0aDogc3RyaW5nKTogUHJvbWlzZTxCdWZmZXI+IHtcbiAgY29uc3Qgc2V2ZW5aaXAgPSBuZXcgdXRpbC5TZXZlblppcCgpO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLmVuc3VyZURpcldyaXRhYmxlQXN5bmMoVzNfVEVNUF9EQVRBX0RJUik7XG4gICAgY29uc3QgYXJjaGl2ZVBhdGggPSBwYXRoLmpvaW4oVzNfVEVNUF9EQVRBX0RJUiwgZ2VuZXJhdGUoKSArICcuemlwJyk7XG4gICAgY29uc3QgZW50cmllczogc3RyaW5nW10gPSBhd2FpdCBmcy5yZWFkZGlyQXN5bmMoZGlyUGF0aCk7XG4gICAgYXdhaXQgc2V2ZW5aaXAuYWRkKGFyY2hpdmVQYXRoLCBlbnRyaWVzLm1hcChlbnRyeSA9PlxuICAgICAgcGF0aC5qb2luKGRpclBhdGgsIGVudHJ5KSksIHsgcmF3OiBbJy1yJ10gfSk7XG5cbiAgICBjb25zdCBkYXRhID0gYXdhaXQgZnMucmVhZEZpbGVBc3luYyhhcmNoaXZlUGF0aCk7XG4gICAgYXdhaXQgZnMucmVtb3ZlQXN5bmMoYXJjaGl2ZVBhdGgpO1xuICAgIHJldHVybiBkYXRhO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xlYW5VcEVudHJpZXMoZmlsZUVudHJpZXM6IElFbnRyeVtdKSB7XG4gIHRyeSB7XG4gICAgZmlsZUVudHJpZXMuc29ydCgobGhzLCByaHMpID0+IHJocy5maWxlUGF0aC5sZW5ndGggLSBsaHMuZmlsZVBhdGgubGVuZ3RoKTtcbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGZpbGVFbnRyaWVzKSB7XG4gICAgICBhd2FpdCBmcy5yZW1vdmVBc3luYyhlbnRyeS5maWxlUGF0aCk7XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2coJ2Vycm9yJywgJ2ZpbGUgZW50cnkgY2xlYW51cCBmYWlsZWQnLCBlcnIpO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXN0b3JlRmlsZURhdGEoZmlsZURhdGE6IEJ1ZmZlciwgZGVzdGluYXRpb246IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBzZXZlblppcCA9IG5ldyB1dGlsLlNldmVuWmlwKCk7XG4gIGxldCBhcmNoaXZlUGF0aDtcbiAgbGV0IGZpbGVFbnRyaWVzOiBJRW50cnlbXSA9IFtdO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLmVuc3VyZURpcldyaXRhYmxlQXN5bmMoVzNfVEVNUF9EQVRBX0RJUik7XG4gICAgYXJjaGl2ZVBhdGggPSBwYXRoLmpvaW4oVzNfVEVNUF9EQVRBX0RJUiwgZ2VuZXJhdGUoKSArICcuemlwJyk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlQXN5bmMoYXJjaGl2ZVBhdGgsIGZpbGVEYXRhKTtcbiAgICBjb25zdCB0YXJnZXREaXJQYXRoID0gcGF0aC5qb2luKFczX1RFTVBfREFUQV9ESVIsIHBhdGguYmFzZW5hbWUoYXJjaGl2ZVBhdGgsICcuemlwJykpO1xuICAgIGF3YWl0IHNldmVuWmlwLmV4dHJhY3RGdWxsKGFyY2hpdmVQYXRoLCB0YXJnZXREaXJQYXRoKTtcbiAgICBmaWxlRW50cmllcyA9IGF3YWl0IHdhbGtEaXJQYXRoKHRhcmdldERpclBhdGgpO1xuICAgIGZvciAoY29uc3QgZW50cnkgb2YgZmlsZUVudHJpZXMpIHtcbiAgICAgIGNvbnN0IHJlbFBhdGggPSBwYXRoLnJlbGF0aXZlKHRhcmdldERpclBhdGgsIGVudHJ5LmZpbGVQYXRoKTtcbiAgICAgIGNvbnN0IGRlc3QgPSBwYXRoLmpvaW4oZGVzdGluYXRpb24sIHJlbFBhdGgpO1xuICAgICAgYXdhaXQgZnMuZW5zdXJlRGlyV3JpdGFibGVBc3luYyhwYXRoLmRpcm5hbWUoZGVzdCkpO1xuICAgICAgYXdhaXQgZnMuY29weUFzeW5jKGVudHJ5LmZpbGVQYXRoLCBkZXN0KTtcbiAgICB9XG4gICAgY2xlYW5VcEVudHJpZXMoZmlsZUVudHJpZXMpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY2xlYW5VcEVudHJpZXMoZmlsZUVudHJpZXMpO1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoZXgyQnVmZmVyKGhleERhdGE6IHN0cmluZykge1xuICBjb25zdCBieXRlQXJyYXkgPSBuZXcgVWludDhBcnJheShoZXhEYXRhLmxlbmd0aCAvIDIpO1xuICBmb3IgKGxldCB4ID0gMDsgeCA8IGJ5dGVBcnJheS5sZW5ndGg7IHgrKykge1xuICAgIGJ5dGVBcnJheVt4XSA9IHBhcnNlSW50KGhleERhdGEuc3Vic3RyKHggKiAyLCAyKSwgMTYpO1xuICB9XG5cbiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oYnl0ZUFycmF5KTtcbiAgcmV0dXJuIGJ1ZmZlcjtcbn1cbiJdfQ==