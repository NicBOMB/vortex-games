"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PriorityManager = void 0;
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
class PriorityManager {
    constructor(api, priorityType) {
        this.resetMaxPriority = (min) => {
            const props = this.genProps(min);
            if (props === undefined) {
                this.mMaxPriority = 0;
                return;
            }
            this.mMaxPriority = this.getMaxPriority(props);
        };
        this.getPriority = (item) => {
            const props = this.genProps();
            const { loadOrder, minPriority } = (props === undefined)
                ? { loadOrder: {}, minPriority: 0 }
                : props;
            const itemKey = Object.keys(loadOrder).find(x => x === item.id);
            if (itemKey !== undefined) {
                if (this.mPriorityType === 'position-based') {
                    const position = loadOrder[itemKey].pos + 1;
                    return (position > minPriority)
                        ? position : ++this.mMaxPriority;
                }
                else {
                    const prefixVal = (loadOrder[itemKey]?.prefix !== undefined)
                        ? parseInt(loadOrder[itemKey].prefix, 10) : loadOrder[itemKey].pos;
                    const posVal = loadOrder[itemKey].pos;
                    if (posVal !== prefixVal && prefixVal > minPriority) {
                        return prefixVal;
                    }
                    else {
                        return (posVal > minPriority)
                            ? posVal : ++this.mMaxPriority;
                    }
                }
            }
            return ++this.mMaxPriority;
        };
        this.genProps = (min) => {
            const state = this.mApi.getState();
            const lastProfId = vortex_api_1.selectors.lastActiveProfileForGame(state, common_1.GAME_ID);
            if (lastProfId === undefined) {
                return undefined;
            }
            const profile = vortex_api_1.selectors.profileById(state, lastProfId);
            if (profile === undefined) {
                return undefined;
            }
            const loadOrder = state?.persistent?.loadOrder?.[lastProfId] ?? {};
            const lockedEntries = Object.keys(loadOrder).filter(key => loadOrder[key]?.locked);
            const minPriority = (min) ? min : lockedEntries.length;
            return { state, profile, loadOrder, minPriority };
        };
        this.getMaxPriority = (props) => {
            const { loadOrder, minPriority } = props;
            return Object.keys(loadOrder).reduce((prev, key) => {
                const prefixVal = (loadOrder[key]?.prefix !== undefined)
                    ? parseInt(loadOrder[key].prefix, 10)
                    : loadOrder[key].pos;
                const posVal = loadOrder[key].pos;
                if (posVal !== prefixVal) {
                    prev = (prefixVal > prev)
                        ? prefixVal : prev;
                }
                else {
                    prev = (posVal > prev)
                        ? posVal : prev;
                }
                return prev;
            }, minPriority);
        };
        this.mApi = api;
        this.mPriorityType = priorityType;
        this.resetMaxPriority();
    }
    set priorityType(type) {
        this.mPriorityType = type;
    }
    get priorityType() {
        return this.mPriorityType;
    }
}
exports.PriorityManager = PriorityManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpb3JpdHlNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJpb3JpdHlNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUFvRDtBQUVwRCxxQ0FBbUM7QUEwQm5DLE1BQWEsZUFBZTtJQUsxQixZQUFZLEdBQXdCLEVBQUUsWUFBMEI7UUFjekQscUJBQWdCLEdBQUcsQ0FBQyxHQUFZLEVBQUUsRUFBRTtZQUN6QyxNQUFNLEtBQUssR0FBVyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3pDLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtnQkFDdkIsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUM7Z0JBQ3RCLE9BQU87YUFDUjtZQUNELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqRCxDQUFDLENBQUE7UUFFTSxnQkFBVyxHQUFHLENBQUMsSUFBaUMsRUFBRSxFQUFFO1lBQ3pELE1BQU0sS0FBSyxHQUFXLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN0QyxNQUFNLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxHQUFHLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQztnQkFDdEQsQ0FBQyxDQUFDLEVBQUUsU0FBUyxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFO2dCQUNuQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBRVYsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hFLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtnQkFDekIsSUFBSSxJQUFJLENBQUMsYUFBYSxLQUFLLGdCQUFnQixFQUFFO29CQUMzQyxNQUFNLFFBQVEsR0FBRyxTQUFT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QUM7Z0JBQ2xDLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtvQkFDeEIsSUFBSSxHQUFHLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQzt3QkFDdkIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO2lCQUN0QjtxQkFBTTtvQkFDTCxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO3dCQUNwQixDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7aUJBQ25CO2dCQUNELE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2xCLENBQUMsQ0FBQTtRQXBGQyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztRQUNoQixJQUFJLENBQUMsYUFBYSxHQUFHLFlBQVksQ0FBQztRQUNsQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBSSxZQUFZLENBQUMsSUFBa0I7UUFDakMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7SUFDNUIsQ0FBQztJQUVELElBQUksWUFBWTtRQUNkLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDO0NBMEVGO0FBM0ZELDBDQTJGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNlbGVjdG9ycywgdHlwZXMsIHV0aWwgfSBmcm9tICd2b3J0ZXgtYXBpJztcblxuaW1wb3J0IHsgR0FNRV9JRCB9IGZyb20gJy4vY29tbW9uJztcblxuZXhwb3J0IHR5cGUgUHJpb3JpdHlUeXBlID0gJ3Bvc2l0aW9uLWJhc2VkJyB8ICdwcmVmaXgtYmFzZWQnO1xuZXhwb3J0IGludGVyZmFjZSBJTG9hZE9yZGVyRW50cnkge1xuICBwb3M6IG51bWJlcjtcbiAgZW5hYmxlZDogYm9vbGVhbjtcbiAgcHJlZml4Pzogc3RyaW5nO1xuICBsb2NrZWQ/OiBib29sZWFuO1xuICBleHRlcm5hbD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUxvYWRPcmRlciB7XG4gIFttb2RJZDogc3RyaW5nXTogSUxvYWRPcmRlckVudHJ5O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElPZmZzZXRNYXAge1xuICBbb2Zmc2V0OiBudW1iZXJdOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICBzdGF0ZTogdHlwZXMuSVN0YXRlO1xuICBwcm9maWxlOiB0eXBlcy5JUHJvZmlsZTtcbiAgbG9hZE9yZGVyOiB7IFttb2RJZDogc3RyaW5nXTogSUxvYWRPcmRlckVudHJ5IH07XG4gIG1pblByaW9yaXR5OiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBQcmlvcml0eU1hbmFnZXIge1xuICBwcml2YXRlIG1BcGk6IHR5cGVzLklFeHRlbnNpb25BcGk7XG4gIHByaXZhdGUgbVByaW9yaXR5VHlwZTogUHJpb3JpdHlUeXBlO1xuICBwcml2YXRlIG1NYXhQcmlvcml0eTogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKGFwaTogdHlwZXMuSUV4dGVuc2lvbkFwaSwgcHJpb3JpdHlUeXBlOiBQcmlvcml0eVR5cGUpIHtcbiAgICB0aGlzLm1BcGkgPSBhcGk7XG4gICAgdGhpcy5tUHJpb3JpdHlUeXBlID0gcHJpb3JpdHlUeXBlO1xuICAgIHRoaXMucmVzZXRNYXhQcmlvcml0eSgpO1xuICB9XG5cbiAgc2V0IHByaW9yaXR5VHlwZSh0eXBlOiBQcmlvcml0eVR5cGUpIHtcbiAgICB0aGlzLm1Qcmlvcml0eVR5cGUgPSB0eXBlO1xuICB9XG5cbiAgZ2V0IHByaW9yaXR5VHlwZSgpIHtcbiAgICByZXR1cm4gdGhpcy5tUHJpb3JpdHlUeXBlO1xuICB9XG5cbiAgcHVibGljIHJlc2V0TWF4UHJpb3JpdHkgPSAobWluPzogbnVtYmVyKSA9PiB7XG4gICAgY29uc3QgcHJvcHM6IElQcm9wcyA9IHRoaXMuZ2VuUHJvcHMobWluKTtcbiAgICBpZiAocHJvcHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5tTWF4UHJpb3JpdHkgPSAwO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm1NYXhQcmlvcml0eSA9IHRoaXMuZ2V0TWF4UHJpb3JpdHkocHJvcHMpO1xuICB9XG5cbiAgcHVibGljIGdldFByaW9yaXR5ID0gKGl0ZW06IHR5cGVzLklMb2FkT3JkZXJEaXNwbGF5SXRlbSkgPT4ge1xuICAgIGNvbnN0IHByb3BzOiBJUHJvcHMgPSB0aGlzLmdlblByb3BzKCk7XG4gICAgY29uc3QgeyBsb2FkT3JkZXIsIG1pblByaW9yaXR5IH0gPSAocHJvcHMgPT09IHVuZGVmaW5lZClcbiAgICAgID8geyBsb2FkT3JkZXI6IHt9LCBtaW5Qcmlvcml0eTogMCB9XG4gICAgICA6IHByb3BzO1xuXG4gICAgY29uc3QgaXRlbUtleSA9IE9iamVjdC5rZXlzKGxvYWRPcmRlcikuZmluZCh4ID0+IHggPT09IGl0ZW0uaWQpO1xuICAgIGlmIChpdGVtS2V5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmICh0aGlzLm1Qcmlvcml0eVR5cGUgPT09ICdwb3NpdGlvbi1iYXNlZCcpIHtcbiAgICAgICAgY29uc3QgcG9zaXRpb24gPSBsb2FkT3JkZXJbaXRlbUtleV0ucG9zICsgMTtcbiAgICAgICAgcmV0dXJuIChwb3NpdGlvbiA+IG1pblByaW9yaXR5KVxuICAgICAgICAgID8gcG9zaXRpb24gOiArK3RoaXMubU1heFByaW9yaXR5O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcHJlZml4VmFsID0gKGxvYWRPcmRlcltpdGVtS2V5XT8ucHJlZml4ICE9PSB1bmRlZmluZWQpXG4gICAgICAgID8gcGFyc2VJbnQobG9hZE9yZGVyW2l0ZW1LZXldLnByZWZpeCwgMTApIDogbG9hZE9yZGVyW2l0ZW1LZXldLnBvcztcbiAgICAgICAgY29uc3QgcG9zVmFsID0gbG9hZE9yZGVyW2l0ZW1LZXldLnBvcztcbiAgICAgICAgaWYgKHBvc1ZhbCAhPT0gcHJlZml4VmFsICYmIHByZWZpeFZhbCA+IG1pblByaW9yaXR5KSB7XG4gICAgICAgICAgcmV0dXJuIHByZWZpeFZhbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gKHBvc1ZhbCA+IG1pblByaW9yaXR5KVxuICAgICAgICAgICAgPyBwb3NWYWwgOiArK3RoaXMubU1heFByaW9yaXR5O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuICsrdGhpcy5tTWF4UHJpb3JpdHk7XG4gIH1cblxuICBwcml2YXRlIGdlblByb3BzID0gKG1pbj86IG51bWJlcik6IElQcm9wcyA9PiB7XG4gICAgY29uc3Qgc3RhdGU6IHR5cGVzLklTdGF0ZSA9IHRoaXMubUFwaS5nZXRTdGF0ZSgpO1xuICAgIGNvbnN0IGxhc3RQcm9mSWQgPSBzZWxlY3RvcnMubGFzdEFjdGl2ZVByb2ZpbGVGb3JHYW1lKHN0YXRlLCBHQU1FX0lEKTtcbiAgICBpZiAobGFzdFByb2ZJZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCBwcm9maWxlID0gc2VsZWN0b3JzLnByb2ZpbGVCeUlkKHN0YXRlLCBsYXN0UHJvZklkKTtcbiAgICBpZiAocHJvZmlsZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGNvbnN0IGxvYWRPcmRlciA9IHN0YXRlPy5wZXJzaXN0ZW50Py5sb2FkT3JkZXI/LltsYXN0UHJvZklkXSA/PyB7fTtcblxuICAgIGNvbnN0IGxvY2tlZEVudHJpZXMgPSBPYmplY3Qua2V5cyhsb2FkT3JkZXIpLmZpbHRlcihrZXkgPT4gbG9hZE9yZGVyW2tleV0/LmxvY2tlZCk7XG4gICAgY29uc3QgbWluUHJpb3JpdHkgPSAobWluKSA/IG1pbiA6IGxvY2tlZEVudHJpZXMubGVuZ3RoO1xuICAgIHJldHVybiB7IHN0YXRlLCBwcm9maWxlLCBsb2FkT3JkZXIsIG1pblByaW9yaXR5IH07XG4gIH1cblxuICBwcml2YXRlIGdldE1heFByaW9yaXR5ID0gKHByb3BzOiBJUHJvcHMpID0+IHtcbiAgICBjb25zdCB7IGxvYWRPcmRlciwgbWluUHJpb3JpdHkgfSA9IHByb3BzO1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhsb2FkT3JkZXIpLnJlZHVjZSgocHJldiwga2V5KSA9PiB7XG4gICAgICBjb25zdCBwcmVmaXhWYWwgPSAobG9hZE9yZGVyW2tleV0/LnByZWZpeCAhPT0gdW5kZWZpbmVkKVxuICAgICAgICA/IHBhcnNlSW50KGxvYWRPcmRlcltrZXldLnByZWZpeCwgMTApXG4gICAgICAgIDogbG9hZE9yZGVyW2tleV0ucG9zO1xuICAgICAgY29uc3QgcG9zVmFsID0gbG9hZE9yZGVyW2tleV0ucG9zO1xuICAgICAgaWYgKHBvc1ZhbCAhPT0gcHJlZml4VmFsKSB7XG4gICAgICAgIHByZXYgPSAocHJlZml4VmFsID4gcHJldilcbiAgICAgICAgICA/IHByZWZpeFZhbCA6IHByZXY7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcmV2ID0gKHBvc1ZhbCA+IHByZXYpXG4gICAgICAgICAgPyBwb3NWYWwgOiBwcmV2O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHByZXY7XG4gICAgfSwgbWluUHJpb3JpdHkpO1xuICB9XG59XG4iXX0=