"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getModInfoFiles = exports.getModName = exports.makePrefix = exports.reversePrefix = exports.getPrefixOffset = exports.ensureLOFile = exports.genProps = exports.toBlue = void 0;
const bluebird_1 = __importDefault(require("bluebird"));
const path_1 = __importDefault(require("path"));
const turbowalk_1 = __importDefault(require("turbowalk"));
const vortex_api_1 = require("vortex-api");
const xml2js_1 = require("xml2js");
const common_1 = require("./common");
function toBlue(func) {
    return (...args) => bluebird_1.default.resolve(func(...args));
}
exports.toBlue = toBlue;
function genProps(context, profileId) {
    const api = context.api;
    const state = api.getState();
    const profile = (profileId !== undefined)
        ? vortex_api_1.selectors.profileById(state, profileId)
        : vortex_api_1.selectors.activeProfile(state);
    if (profile?.gameId !== common_1.GAME_ID) {
        return undefined;
    }
    const discovery = state?.settings?.gameMode?.discovered?.[common_1.GAME_ID];
    if (discovery?.path === undefined) {
        return undefined;
    }
    const mods = state?.persistent?.mods?.[common_1.GAME_ID] ?? {};
    return { api, state, profile, mods, discovery };
}
exports.genProps = genProps;
async function ensureLOFile(context, profileId, props) {
    if (props === undefined) {
        props = genProps(context, profileId);
    }
    if (props === undefined) {
        return Promise.reject(new vortex_api_1.util.ProcessCanceled('failed to generate game props'));
    }
    const targetPath = (0, common_1.loadOrderFilePath)(props.profile.id);
    try {
        await vortex_api_1.fs.statAsync(targetPath)
            .catch({ code: 'ENOENT' }, () => vortex_api_1.fs.writeFileAsync(targetPath, JSON.stringify([]), { encoding: 'utf8' }));
        return targetPath;
    }
    catch (err) {
        return Promise.reject(err);
    }
}
exports.ensureLOFile = ensureLOFile;
function getPrefixOffset(api) {
    const state = api.getState();
    const profileId = vortex_api_1.selectors.activeProfile(state)?.id;
    if (profileId === undefined) {
        api.showErrorNotification('No active profile for 7dtd', undefined, { allowReport: false });
        return;
    }
    return state?.settings?.['7daystodie']?.prefixOffset?.[profileId] ?? 0;
}
exports.getPrefixOffset = getPrefixOffset;
function reversePrefix(input) {
    if (input.length !== 3 || input.match(/[A-Z][A-Z][A-Z]/g) === null) {
        throw new vortex_api_1.util.DataInvalid('Invalid input, please provide a valid prefix (AAA-ZZZ)');
    }
    const prefix = input.split('');
    const offset = prefix.reduce((prev, iter, idx) => {
        const pow = 2 - idx;
        const mult = Math.pow(26, pow);
        const charCode = (iter.charCodeAt(0) % 65);
        prev = prev + (charCode * mult);
        return prev;
    }, 0);
    return offset;
}
exports.reversePrefix = reversePrefix;
function makePrefix(input) {
    let res = '';
    let rest = input;
    while (rest > 0) {
        res = String.fromCharCode(65 + (rest % 26)) + res;
        rest = Math.floor(rest / 26);
    }
    return vortex_api_1.util.pad(res, 'A', 3);
}
exports.makePrefix = makePrefix;
async function getModName(modInfoPath) {
    let modInfo;
    try {
        const xmlData = await vortex_api_1.fs.readFileAsync(modInfoPath);
        modInfo = await (0, xml2js_1.parseStringPromise)(xmlData);
        const modName = modInfo?.ModInfo?.[0].Name?.[0]?.$?.value
            || modInfo?.xml.ModInfo?.[0]?.Name?.[0]?.$?.value;
        return (modName !== undefined)
            ? Promise.resolve(modName)
            : Promise.reject(new vortex_api_1.util.DataInvalid('Unexpected modinfo.xml format'));
    }
    catch (err) {
        return Promise.reject(new vortex_api_1.util.DataInvalid('Failed to parse ModInfo.xml file'));
    }
}
exports.getModName = getModName;
async function getModInfoFiles(basePath) {
    let filePaths = [];
    return (0, turbowalk_1.default)(basePath, files => {
        const filtered = files.filter(entry => !entry.isDirectory && path_1.default.basename(entry.filePath) === common_1.MOD_INFO);
        filePaths = filePaths.concat(filtered.map(entry => entry.filePath));
    }, { recurse: true, skipLinks: true })
        .catch(err => ['ENOENT', 'ENOTFOUND'].includes(err.code)
        ? Promise.resolve() : Promise.reject(err))
        .then(() => Promise.resolve(filePaths));
}
exports.getModInfoFiles = getModInfoFiles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0RBQWdDO0FBQ2hDLGdEQUF3QjtBQUN4QiwwREFBa0M7QUFDbEMsMkNBQXdEO0FBQ3hELG1DQUE0QztBQUU1QyxxQ0FBZ0U7QUFLaEUsU0FBZ0IsTUFBTSxDQUFJLElBQW9DO0lBQzVELE9BQU8sQ0FBQyxHQUFHLElBQVcsRUFBRSxFQUFFLENBQUMsa0JBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUM3RCxDQUFDO0FBRkQsd0JBRUM7QUFFRCxTQUFnQixRQUFRLENBQUMsT0FBZ0MsRUFBRSxTQUFrQjtJQUMzRSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0lBQ3hCLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM3QixNQUFNLE9BQU8sR0FBbUIsQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxzQkFBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxzQkFBUyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUVuQyxJQUFJLE9BQU8sRUFBRSxNQUFNLEtBQUssZ0JBQU8sRUFBRTtRQUMvQixPQUFPLFNBQVMsQ0FBQztLQUNsQjtJQUVELE1BQU0sU0FBUyxHQUEyQixLQUFLLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsQ0FBQyxnQkFBTyxDQUFDLENBQUM7SUFDM0YsSUFBSSxTQUFTLEVBQUUsSUFBSSxLQUFLLFNBQVMsRUFBRTtRQUNqQyxPQUFPLFNBQVMsQ0FBQztLQUNsQjtJQUVELE1BQU0sSUFBSSxHQUFHLEtBQUssRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLENBQUMsZ0JBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FB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bXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB0dXJib3dhbGsgZnJvbSAndHVyYm93YWxrJztcbmltcG9ydCB7IGZzLCBzZWxlY3RvcnMsIHR5cGVzLCB1dGlsIH0gZnJvbSAndm9ydGV4LWFwaSc7XG5pbXBvcnQgeyBwYXJzZVN0cmluZ1Byb21pc2UgfSBmcm9tICd4bWwyanMnO1xuXG5pbXBvcnQgeyBHQU1FX0lELCBNT0RfSU5GTywgbG9hZE9yZGVyRmlsZVBhdGggfSBmcm9tICcuL2NvbW1vbic7XG5pbXBvcnQgeyBJUHJvcHMgfSBmcm9tICcuL3R5cGVzJztcblxuLy8gV2UgX3Nob3VsZF8ganVzdCBleHBvcnQgdGhpcyBmcm9tIHZvcnRleC1hcGksIGJ1dCBJIGd1ZXNzIGl0J3Mgbm90IHdpc2UgdG8gbWFrZSBpdFxuLy8gIGVhc3kgZm9yIHVzZXJzIHNpbmNlIHdlIHdhbnQgdG8gbW92ZSBhd2F5IGZyb20gYmx1ZWJpcmQgaW4gdGhlIGZ1dHVyZSA/XG5leHBvcnQgZnVuY3Rpb24gdG9CbHVlPFQ+KGZ1bmM6ICguLi5hcmdzOiBhbnlbXSkgPT4gUHJvbWlzZTxUPik6ICguLi5hcmdzOiBhbnlbXSkgPT4gQmx1ZWJpcmQ8VD4ge1xuICByZXR1cm4gKC4uLmFyZ3M6IGFueVtdKSA9PiBCbHVlYmlyZC5yZXNvbHZlKGZ1bmMoLi4uYXJncykpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2VuUHJvcHMoY29udGV4dDogdHlwZXMuSUV4dGVuc2lvbkNvbnRleHQsIHByb2ZpbGVJZD86IHN0cmluZyk6IElQcm9wcyB7XG4gIGNvbnN0IGFwaSA9IGNvbnRleHQuYXBpO1xuICBjb25zdCBzdGF0ZSA9IGFwaS5nZXRTdGF0ZSgpO1xuICBjb25zdCBwcm9maWxlOiB0eXBlcy5JUHJvZmlsZSA9IChwcm9maWxlSWQgIT09IHVuZGVmaW5lZClcbiAgICA/IHNlbGVjdG9ycy5wcm9maWxlQnlJZChzdGF0ZSwgcHJvZmlsZUlkKVxuICAgIDogc2VsZWN0b3JzLmFjdGl2ZVByb2ZpbGUoc3RhdGUpO1xuXG4gIGlmIChwcm9maWxlPy5nYW1lSWQgIT09IEdBTUVfSUQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgZGlzY292ZXJ5OiB0eXBlcy5JRGlzY292ZXJ5UmVzdWx0ID0gc3RhdGU/LnNldHRpbmdzPy5nYW1lTW9kZT8uZGlzY292ZXJlZD8uW0dBTUVfSURdO1xuICBpZiAoZGlzY292ZXJ5Py5wYXRoID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgbW9kcyA9IHN0YXRlPy5wZXJzaXN0ZW50Py5tb2RzPy5bR0FNRV9JRF0gPz8ge307XG4gIHJldHVybiB7IGFwaSwgc3RhdGUsIHByb2ZpbGUsIG1vZHMsIGRpc2NvdmVyeSB9O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZW5zdXJlTE9GaWxlKGNvbnRleHQ6IHR5cGVzLklFeHRlbnNpb25Db250ZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9maWxlSWQ/OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzPzogSVByb3BzKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgaWYgKHByb3BzID09PSB1bmRlZmluZWQpIHtcbiAgICBwcm9wcyA9IGdlblByb3BzKGNvbnRleHQsIHByb2ZpbGVJZCk7XG4gIH1cblxuICBpZiAocHJvcHMgPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgdXRpbC5Qcm9jZXNzQ2FuY2VsZWQoJ2ZhaWxlZCB0byBnZW5lcmF0ZSBnYW1lIHByb3BzJykpO1xuICB9XG5cbiAgY29uc3QgdGFyZ2V0UGF0aCA9IGxvYWRPcmRlckZpbGVQYXRoKHByb3BzLnByb2ZpbGUuaWQpO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLnN0YXRBc3luYyh0YXJnZXRQYXRoKVxuICAgICAgLmNhdGNoKHsgY29kZTogJ0VOT0VOVCcgfSwgKCkgPT4gZnMud3JpdGVGaWxlQXN5bmModGFyZ2V0UGF0aCwgSlNPTi5zdHJpbmdpZnkoW10pLCB7IGVuY29kaW5nOiAndXRmOCcgfSkpO1xuICAgIHJldHVybiB0YXJnZXRQYXRoO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJlZml4T2Zmc2V0KGFwaTogdHlwZXMuSUV4dGVuc2lvbkFwaSk6IG51bWJlciB7XG4gIGNvbnN0IHN0YXRlID0gYXBpLmdldFN0YXRlKCk7XG4gIGNvbnN0IHByb2ZpbGVJZCA9IHNlbGVjdG9ycy5hY3RpdmVQcm9maWxlKHN0YXRlKT8uaWQ7XG4gIGlmIChwcm9maWxlSWQgPT09IHVuZGVmaW5lZCkge1xuICAgIC8vIEhvdyA/XG4gICAgYXBpLnNob3dFcnJvck5vdGlmaWNhdGlvbignTm8gYWN0aXZlIHByb2ZpbGUgZm9yIDdkdGQnLCB1bmRlZmluZWQsIHsgYWxsb3dSZXBvcnQ6IGZhbHNlIH0pO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJldHVybiBzdGF0ZT8uc2V0dGluZ3M/LlsnN2RheXN0b2RpZSddPy5wcmVmaXhPZmZzZXQ/Lltwcm9maWxlSWRdID8/IDA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXZlcnNlUHJlZml4KGlucHV0OiBzdHJpbmcpOiBudW1iZXIge1xuICBpZiAoaW5wdXQubGVuZ3RoICE9PSAzIHx8IGlucHV0Lm1hdGNoKC9bQS1aXVtBLVpdW0EtWl0vZykgPT09IG51bGwpIHtcbiAgICB0aHJvdyBuZXcgdXRpbC5EYXRhSW52YWxpZCgnSW52YWxpZCBpbnB1dCwgcGxlYXNlIHByb3ZpZGUgYSB2YWxpZCBwcmVmaXggKEFBQS1aWlopJyk7XG4gIH1cbiAgY29uc3QgcHJlZml4ID0gaW5wdXQuc3BsaXQoJycpO1xuXG4gIGNvbnN0IG9mZnNldCA9IHByZWZpeC5yZWR1Y2UoKHByZXYsIGl0ZXIsIGlkeCkgPT4ge1xuICAgIGNvbnN0IHBvdyA9IDIgLSBpZHg7XG4gICAgY29uc3QgbXVsdCA9IE1hdGgucG93KDI2LCBwb3cpO1xuICAgIGNvbnN0IGNoYXJDb2RlID0gKGl0ZXIuY2hhckNvZGVBdCgwKSAlIDY1KTtcbiAgICBwcmV2ID0gcHJldiArIChjaGFyQ29kZSAqIG11bHQpO1xuICAgIHJldHVybiBwcmV2O1xuICB9LCAwKTtcblxuICByZXR1cm4gb2Zmc2V0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFrZVByZWZpeChpbnB1dDogbnVtYmVyKSB7XG4gIGxldCByZXMgPSAnJztcbiAgbGV0IHJlc3QgPSBpbnB1dDtcbiAgd2hpbGUgKHJlc3QgPiAwKSB7XG4gICAgcmVzID0gU3RyaW5nLmZyb21DaGFyQ29kZSg2NSArIChyZXN0ICUgMjYpKSArIHJlcztcbiAgICByZXN0ID0gTWF0aC5mbG9vcihyZXN0IC8gMjYpO1xuICB9XG4gIHJldHVybiB1dGlsLnBhZCgocmVzIGFzIGFueSksICdBJywgMyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRNb2ROYW1lKG1vZEluZm9QYXRoKTogUHJvbWlzZTxhbnk+IHtcbiAgbGV0IG1vZEluZm87XG4gIHRyeSB7XG4gICAgY29uc3QgeG1sRGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlQXN5bmMobW9kSW5mb1BhdGgpO1xuICAgIG1vZEluZm8gPSBhd2FpdCBwYXJzZVN0cmluZ1Byb21pc2UoeG1sRGF0YSk7XG4gICAgY29uc3QgbW9kTmFtZSA9IG1vZEluZm8/Lk1vZEluZm8/LlswXS5OYW1lPy5bMF0/LiQ/LnZhbHVlXG4gICAgICAgICAgICAgICAgIHx8IG1vZEluZm8/LnhtbC5Nb2RJbmZvPy5bMF0/Lk5hbWU/LlswXT8uJD8udmFsdWU7XG4gICAgcmV0dXJuIChtb2ROYW1lICE9PSB1bmRlZmluZWQpXG4gICAgICA/IFByb21pc2UucmVzb2x2ZShtb2ROYW1lKVxuICAgICAgOiBQcm9taXNlLnJlamVjdChuZXcgdXRpbC5EYXRhSW52YWxpZCgnVW5leHBlY3RlZCBtb2RpbmZvLnhtbCBmb3JtYXQnKSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgdXRpbC5EYXRhSW52YWxpZCgnRmFpbGVkIHRvIHBhcnNlIE1vZEluZm8ueG1sIGZpbGUnKSk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE1vZEluZm9GaWxlcyhiYXNlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICBsZXQgZmlsZVBhdGhzOiBzdHJpbmdbXSA9IFtdO1xuICByZXR1cm4gdHVyYm93YWxrKGJhc2VQYXRoLCBmaWxlcyA9PiB7XG4gICAgY29uc3QgZmlsdGVyZWQgPSBmaWxlcy5maWx0ZXIoZW50cnkgPT5cbiAgICAgICFlbnRyeS5pc0RpcmVjdG9yeSAmJiBwYXRoLmJhc2VuYW1lKGVudHJ5LmZpbGVQYXRoKSA9PT0gTU9EX0lORk8pO1xuICAgIGZpbGVQYXRocyA9IGZpbGVQYXRocy5jb25jYXQoZmlsdGVyZWQubWFwKGVudHJ5ID0+IGVudHJ5LmZpbGVQYXRoKSk7XG4gIH0sIHsgcmVjdXJzZTogdHJ1ZSwgc2tpcExpbmtzOiB0cnVlIH0pXG4gIC5jYXRjaChlcnIgPT4gWydFTk9FTlQnLCAnRU5PVEZPVU5EJ10uaW5jbHVkZXMoZXJyLmNvZGUpXG4gICAgPyBQcm9taXNlLnJlc29sdmUoKSA6IFByb21pc2UucmVqZWN0KGVycikpXG4gIC50aGVuKCgpID0+IFByb21pc2UucmVzb2x2ZShmaWxlUGF0aHMpKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQXR0cmlidXRlIGV4dGVuZHMgSVhtbE5vZGU8eyBpZDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfT4ge31cbmV4cG9ydCBpbnRlcmZhY2UgSVhtbE5vZGU8QXR0cmlidXRlVCBleHRlbmRzIG9iamVjdD4ge1xuICAkOiBBdHRyaWJ1dGVUO1xufVxuZXhwb3J0IGludGVyZmFjZSBJTW9kTmFtZU5vZGUgZXh0ZW5kcyBJWG1sTm9kZTx7IGlkOiAnTmFtZScgfT4ge1xuICBhdHRyaWJ1dGU6IElBdHRyaWJ1dGU7XG59XG5leHBvcnQgaW50ZXJmYWNlIElNb2RJbmZvTm9kZSBleHRlbmRzIElYbWxOb2RlPHsgaWQ6ICdNb2RJbmZvJyB9PiB7XG4gIGNoaWxkcmVuPzogW3sgbm9kZTogSU1vZE5hbWVOb2RlW10gfV07XG4gIGF0dHJpYnV0ZT86IElBdHRyaWJ1dGVbXTtcbn1cbiJdfQ==