"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getValidationInfo = exports.isInvalid = exports.parseLauncherData = exports.refreshCache = exports.getCache = exports.getLauncherData = void 0;
const bluebird_1 = __importDefault(require("bluebird"));
const path_1 = __importDefault(require("path"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const util_1 = require("./util");
const XML_EL_MULTIPLAYER = 'MultiplayerModule';
const LAUNCHER_DATA_PATH = path_1.default.join(vortex_api_1.util.getVortexPath('documents'), 'Mount and Blade II Bannerlord', 'Configs', 'LauncherData.xml');
const LAUNCHER_DATA = {
    singlePlayerSubMods: [],
    multiplayerSubMods: [],
};
function getLauncherData() {
    return LAUNCHER_DATA;
}
exports.getLauncherData = getLauncherData;
let CACHE = {};
function getCache() {
    return CACHE;
}
exports.getCache = getCache;
async function refreshCache(context, metaManager) {
    try {
        CACHE = {};
        const subModuleFilePaths = await getDeployedSubModPaths(context);
        CACHE = await getDeployedModData(context, subModuleFilePaths, metaManager);
    }
    catch (err) {
        return Promise.reject(err);
    }
}
exports.refreshCache = refreshCache;
async function getDeployedSubModPaths(context) {
    const state = context.api.store.getState();
    const discovery = state?.settings?.gameMode?.discovered?.[common_1.GAME_ID];
    if (discovery?.path === undefined) {
        return Promise.reject(new vortex_api_1.util.ProcessCanceled('game discovery is incomplete'));
    }
    const modulePath = path_1.default.join(discovery.path, common_1.MODULES);
    let moduleFiles;
    try {
        moduleFiles = await (0, util_1.walkAsync)(modulePath);
    }
    catch (err) {
        if (err instanceof vortex_api_1.util.UserCanceled) {
            return Promise.resolve([]);
        }
        const isMissingOfficialModules = ((err.code === 'ENOENT')
            && ([].concat([common_1.MODULES], Array.from(common_1.OFFICIAL_MODULES)))
                .indexOf(path_1.default.basename(err.path)) !== -1);
        const errorMsg = isMissingOfficialModules
            ? 'Game files are missing - please re-install the game'
            : err.message;
        context.api.showErrorNotification(errorMsg, err);
        return Promise.resolve([]);
    }
    const subModules = moduleFiles.filter(file => path_1.default.basename(file).toLowerCase() === common_1.SUBMOD_FILE);
    return Promise.resolve(subModules);
}
async function getDeployedModData(context, subModuleFilePaths, metaManager) {
    const state = context.api.getState();
    const profileId = vortex_api_1.selectors.activeProfile(state)?.id;
    if (profileId === undefined) {
        return undefined;
    }
    await metaManager.updateDependencyMap(profileId);
    const managedIds = await getManagedIds(context);
    return bluebird_1.default.reduce(subModuleFilePaths, async (accum, subModFile) => {
        try {
            const getAttrValue = (node, attr) => node?.[attr]?.[0]?.$?.value;
            const subModData = await (0, util_1.getXMLData)(subModFile);
            const module = subModData?.Module;
            const subModId = getAttrValue(module, 'Id');
            const comDependencies = metaManager.getDependencies(subModId);
            const subModVerData = getAttrValue(module, 'Version');
            const subModVer = (0, util_1.getCleanVersion)(subModId, subModVerData);
            const managedEntry = managedIds.find(entry => entry.subModId === subModId);
            const isMultiplayer = getAttrValue(module, XML_EL_MULTIPLAYER) !== undefined;
            const officialDepNodes = module?.DependedModules?.[0]?.DependedModule || [];
            let dependencies = [];
            const getOfficialDepNodes = () => officialDepNodes
                .filter(depNode => comDependencies.find(dep => dep.id === depNode?.$?.Id) === undefined)
                .map(depNode => {
                let depVersion;
                const depId = depNode?.$?.Id;
                try {
                    const unsanitized = depNode?.$?.DependentVersion;
                    depVersion = (0, util_1.getCleanVersion)(subModId, unsanitized);
                }
                catch (err) {
                    (0, vortex_api_1.log)('debug', 'failed to resolve dependency version', { subModId, error: err.message });
                }
                const dependency = {
                    id: depId,
                    incompatible: false,
                    optional: false,
                    order: 'LoadAfterThis',
                    version: depVersion,
                };
                return dependency;
            });
            try {
                dependencies = (comDependencies.length > 0)
                    ? [].concat(getOfficialDepNodes(), comDependencies)
                    : getOfficialDepNodes();
            }
            catch (err) {
                (0, vortex_api_1.log)('debug', 'submodule has no dependencies or is invalid', err);
            }
            const subModName = getAttrValue(module, 'Name');
            accum[subModId] = {
                subModId,
                subModName,
                subModVer,
                subModFile,
                vortexId: !!managedEntry ? managedEntry.vortexId : subModId,
                isOfficial: common_1.OFFICIAL_MODULES.has(subModId),
                isLocked: common_1.LOCKED_MODULES.has(subModId),
                isMultiplayer,
                dependencies,
                invalid: {
                    cyclic: [],
                    missing: [],
                    incompatibleDeps: [],
                },
            };
        }
        catch (err) {
            const errorMessage = 'Vortex was unable to parse: ' + subModFile + ';\n\n'
                + 'You can either inform the mod author and wait for fix, or '
                + 'you can use an online xml validator to find and fix the '
                + 'error yourself.';
            context.api.showErrorNotification('Unable to parse submodule file', errorMessage, { allowReport: false });
            (0, vortex_api_1.log)('error', 'MNB2: parsing error', err);
        }
        return Promise.resolve(accum);
    }, {});
}
async function parseLauncherData() {
    const createDataElement = (xmlNode) => {
        if (xmlNode === undefined) {
            return undefined;
        }
        return {
            subModId: xmlNode?.Id[0],
            enabled: xmlNode?.IsSelected[0] === 'true',
        };
    };
    const launcherData = await (0, util_1.getXMLData)(LAUNCHER_DATA_PATH);
    try {
        const singlePlayerMods = launcherData?.UserData?.SingleplayerData?.[0]?.ModDatas?.[0]?.UserModData || [];
        const multiPlayerMods = launcherData?.UserData?.MultiplayerData?.[0]?.ModDatas?.[0]?.UserModData || [];
        LAUNCHER_DATA.singlePlayerSubMods = singlePlayerMods.reduce((accum, spm) => {
            const dataElement = createDataElement(spm);
            if (!!dataElement) {
                accum.push(dataElement);
            }
            return accum;
        }, []);
        LAUNCHER_DATA.multiplayerSubMods = multiPlayerMods.reduce((accum, mpm) => {
            const dataElement = createDataElement(mpm);
            if (!!dataElement) {
                accum.push(dataElement);
            }
            return accum;
        }, []);
    }
    catch (err) {
        (0, vortex_api_1.log)('error', 'failed to parse launcher data', err);
        LAUNCHER_DATA.singlePlayerSubMods = [
            { subModId: 'Native', enabled: true },
            { subModId: 'SandBoxCore', enabled: true },
            { subModId: 'CustomBattle', enabled: true },
            { subModId: 'Sandbox', enabled: true },
            { subModId: 'StoryMode', enabled: true },
        ];
        LAUNCHER_DATA.multiplayerSubMods = [];
        return Promise.resolve();
    }
}
exports.parseLauncherData = parseLauncherData;
async function getManagedIds(context) {
    const state = context.api.store.getState();
    const activeProfile = vortex_api_1.selectors.activeProfile(state);
    if (activeProfile === undefined) {
        return Promise.resolve([]);
    }
    const modState = state?.persistent?.profiles?.[activeProfile.id]?.modState ?? {};
    const mods = state?.persistent?.mods?.[common_1.GAME_ID] ?? {};
    const enabledMods = Object.keys(modState)
        .filter(key => !!mods[key] && modState[key].enabled)
        .map(key => mods[key]);
    const invalidMods = [];
    const installationDir = vortex_api_1.selectors.installPathForGame(state, common_1.GAME_ID);
    if (installationDir === undefined) {
        (0, vortex_api_1.log)('error', 'failed to get managed ids', 'undefined staging folder');
        return Promise.resolve([]);
    }
    return bluebird_1.default.reduce(enabledMods, async (accum, entry) => {
        if (entry?.installationPath === undefined) {
            return Promise.resolve(accum);
        }
        const modInstallationPath = path_1.default.join(installationDir, entry.installationPath);
        let files;
        try {
            files = await (0, util_1.walkAsync)(modInstallationPath, 3);
        }
        catch (err) {
            invalidMods.push(entry.id);
            (0, vortex_api_1.log)('error', 'failed to read mod staging folder', { modId: entry.id, error: err.message });
            return Promise.resolve(accum);
        }
        const subModFile = files.find(file => path_1.default.basename(file).toLowerCase() === common_1.SUBMOD_FILE);
        if (subModFile === undefined) {
            return Promise.resolve(accum);
        }
        let subModId;
        try {
            subModId = await (0, util_1.getElementValue)(subModFile, 'Id');
        }
        catch (err) {
            (0, vortex_api_1.log)('error', '[MnB2] Unable to parse submodule file', err);
            return Promise.resolve(accum);
        }
        accum.push({
            subModId,
            subModFile,
            vortexId: entry.id,
        });
        return Promise.resolve(accum);
    }, [])
        .tap((res) => {
        if (invalidMods.length > 0) {
            const errMessage = 'The following mods are inaccessible or are missing '
                + 'in the staging folder:\n\n' + invalidMods.join('\n') + '\n\nPlease ensure '
                + 'these mods and their content are not open in any other application '
                + '(including the game itself). If the mod is missing entirely, please re-install it '
                + 'or remove it from your mods page. Please check your vortex log file for details.';
            context.api.showErrorNotification('Invalid Mods in Staging', new Error(errMessage), { allowReport: false });
        }
        return Promise.resolve(res);
    });
}
function isInvalid(subModId) {
    const cyclicErrors = CACHE[subModId]?.invalid?.cyclic ?? [];
    const missingDeps = CACHE[subModId]?.invalid?.missing ?? [];
    return ((cyclicErrors.length > 0) || (missingDeps.length > 0));
}
exports.isInvalid = isInvalid;
function getValidationInfo(vortexId) {
    const subModId = Object.keys(CACHE).find(key => CACHE[key].vortexId === vortexId);
    const cyclic = CACHE[subModId]?.invalid?.cyclic ?? [];
    const missing = CACHE[subModId]?.invalid?.missing ?? [];
    const incompatible = CACHE[subModId]?.invalid?.incompatibleDeps ?? [];
    return {
        cyclic,
        missing,
        incompatible,
    };
}
exports.getValidationInfo = getValidationInfo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViTW9kQ2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdWJNb2RDYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSx3REFBZ0M7QUFDaEMsZ0RBQXdCO0FBQ3hCLDJDQUF5RDtBQUV6RCxxQ0FDa0Q7QUFFbEQsaUNBQWlGO0FBRWpGLE1BQU0sa0JBQWtCLEdBQUcsbUJBQW1CLENBQUM7QUFDL0MsTUFBTSxrQkFBa0IsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxFQUFFLCtCQUErQixFQUFFLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0FBQ3RJLE1BQU0sYUFBYSxHQUFHO0lBQ3BCLG1CQUFtQixFQUFFLEVBQUU7SUFDdkIsa0JBQWtCLEVBQUUsRUFBRTtDQUN2QixDQUFDO0FBRUYsU0FBZ0IsZUFBZTtJQUM3QixPQUFPLGFBQWEsQ0FBQztBQUN2QixDQUFDO0FBRkQsMENBRUM7QUFFRCxJQUFJLEtBQUssR0FBaUIsRUFBRSxDQUFDO0FBQzdCLFNBQWdCLFFBQVE7SUFDdEIsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBRkQsNEJBRUM7QUFFTSxLQUFLLFVBQVUsWUFBWSxDQUFDLE9BQWdDLEVBQ2hDLFdBQStCO0lBQ2hFLElBQUk7UUFDRixLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ1gsTUFBTSxrQkFBa0IsR0FBYSxNQUFNLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNFLEtBQUssR0FBRyxNQUFNLGtCQUFrQixDQUFDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxXQUFXLENBQUMsQ0FBQztLQUM1RTtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1osT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQzVCO0FBQ0gsQ0FBQztBQVRELG9DQVNDO0FBRUQsS0FBSyxVQUFVLHNCQUFzQixDQUFDLE9BQWdDO0lBQ3BFLE1BQU0s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T0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQWdCLFNBQVMsQ0FBQyxRQUFnQjtJQUN4QyxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsT0FBTyxFQUFFLE1BQU0sSUFBSSxFQUFFLENBQUM7SUFDNUQsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLElBQUksRUFBRSxDQUFDO0lBQzVELE9BQU8sQ0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDakUsQ0FBQztBQUpELDhCQUlDO0FBRUQsU0FBZ0IsaUJBQWlCLENBQUMsUUFBZ0I7SUFJaEQsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxLQUFLLFFBQVEsQ0FBQyxDQUFDO0lBQ2xGLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxPQUFPLEVBQUUsTUFBTSxJQUFJLEVBQUUsQ0FBQztJQUN0RCxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsT0FBTyxFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFDeEQsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsSUFBSSxFQUFFLENBQUM7SUFDdEUsT0FBTztRQUNMLE1BQU07UUFDTixPQUFPO1FBQ1AsWUFBWTtLQUNiLENBQUM7QUFDSixDQUFDO0FBYkQsOENBYUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmx1ZWJpcmQgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBsb2csIHNlbGVjdG9ycywgdHlwZXMsIHV0aWwgfSBmcm9tICd2b3J0ZXgtYXBpJztcbmltcG9ydCBDb21NZXRhZGF0YU1hbmFnZXIgZnJvbSAnLi9Db21NZXRhZGF0YU1hbmFnZXInO1xuaW1wb3J0IHsgR0FNRV9JRCwgTE9DS0VEX01PRFVMRVMsIE1PRFVMRVMsXG4gIE9GRklDSUFMX01PRFVMRVMsIFNVQk1PRF9GSUxFIH0gZnJvbSAnLi9jb21tb24nO1xuaW1wb3J0IHsgSURlcGVuZGVuY3ksIElTdWJNb2RDYWNoZSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgZ2V0Q2xlYW5WZXJzaW9uLCBnZXRFbGVtZW50VmFsdWUsIGdldFhNTERhdGEsIHdhbGtBc3luYyB9IGZyb20gJy4vdXRpbCc7XG5cbmNvbnN0IFhNTF9FTF9NVUxUSVBMQVlFUiA9ICdNdWx0aXBsYXllck1vZHVsZSc7XG5jb25zdCBMQVVOQ0hFUl9EQVRBX1BBVEggPSBwYXRoLmpvaW4odXRpbC5nZXRWb3J0ZXhQYXRoKCdkb2N1bWVudHMnKSwgJ01vdW50IGFuZCBCbGFkZSBJSSBCYW5uZXJsb3JkJywgJ0NvbmZpZ3MnLCAnTGF1bmNoZXJEYXRhLnhtbCcpO1xuY29uc3QgTEFVTkNIRVJfREFUQSA9IHtcbiAgc2luZ2xlUGxheWVyU3ViTW9kczogW10sXG4gIG11bHRpcGxheWVyU3ViTW9kczogW10sXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TGF1bmNoZXJEYXRhKCkge1xuICByZXR1cm4gTEFVTkNIRVJfREFUQTtcbn1cblxubGV0IENBQ0hFOiBJU3ViTW9kQ2FjaGUgPSB7fTtcbmV4cG9ydCBmdW5jdGlvbiBnZXRDYWNoZSgpIHtcbiAgcmV0dXJuIENBQ0hFO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVmcmVzaENhY2hlKGNvbnRleHQ6IHR5cGVzLklFeHRlbnNpb25Db250ZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRhTWFuYWdlcjogQ29tTWV0YWRhdGFNYW5hZ2VyKSB7XG4gIHRyeSB7XG4gICAgQ0FDSEUgPSB7fTtcbiAgICBjb25zdCBzdWJNb2R1bGVGaWxlUGF0aHM6IHN0cmluZ1tdID0gYXdhaXQgZ2V0RGVwbG95ZWRTdWJNb2RQYXRocyhjb250ZXh0KTtcbiAgICBDQUNIRSA9IGF3YWl0IGdldERlcGxveWVkTW9kRGF0YShjb250ZXh0LCBzdWJNb2R1bGVGaWxlUGF0aHMsIG1ldGFNYW5hZ2VyKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycik7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGVwbG95ZWRTdWJNb2RQYXRocyhjb250ZXh0OiB0eXBlcy5JRXh0ZW5zaW9uQ29udGV4dCkge1xuICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLnN0b3JlLmdldFN0YXRlKCk7XG4gIGNvbnN0IGRpc2NvdmVyeSA9IHN0YXRlPy5zZXR0aW5ncz8uZ2FtZU1vZGU/LmRpc2NvdmVyZWQ/LltHQU1FX0lEXTtcbiAgaWYgKGRpc2NvdmVyeT8ucGF0aCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyB1dGlsLlByb2Nlc3NDYW5jZWxlZCgnZ2FtZSBkaXNjb3ZlcnkgaXMgaW5jb21wbGV0ZScpKTtcbiAgfVxuICBjb25zdCBtb2R1bGVQYXRoID0gcGF0aC5qb2luKGRpc2NvdmVyeS5wYXRoLCBNT0RVTEVTKTtcbiAgbGV0IG1vZHVsZUZpbGVzO1xuICB0cnkge1xuICAgIG1vZHVsZUZpbGVzID0gYXdhaXQgd2Fsa0FzeW5jKG1vZHVsZVBhdGgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyIGluc3RhbmNlb2YgdXRpbC5Vc2VyQ2FuY2VsZWQpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xuICAgIH1cbiAgICBjb25zdCBpc01pc3NpbmdPZmZpY2lhbE1vZHVsZXMgPSAoKGVyci5jb2RlID09PSAnRU5PRU5UJylcbiAgICAgICYmIChbXS5jb25jYXQoWyBNT0RVTEVTIF0sIEFycmF5LmZyb20oT0ZGSUNJQUxfTU9EVUxFUykpKVxuICAgICAgICAgICAgLmluZGV4T2YocGF0aC5iYXNlbmFtZShlcnIucGF0aCkpICE9PSAtMSk7XG4gICAgY29uc3QgZXJyb3JNc2cgPSBpc01pc3NpbmdPZmZpY2lhbE1vZHVsZXNcbiAgICAgID8gJ0dhbWUgZmlsZXMgYXJlIG1pc3NpbmcgLSBwbGVhc2UgcmUtaW5zdGFsbCB0aGUgZ2FtZSdcbiAgICAgIDogZXJyLm1lc3NhZ2U7XG4gICAgY29udGV4dC5hcGkuc2hvd0Vycm9yTm90aWZpY2F0aW9uKGVycm9yTXNnLCBlcnIpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xuICB9XG4gIGNvbnN0IHN1Yk1vZHVsZXMgPSBtb2R1bGVGaWxlcy5maWx0ZXIoZmlsZSA9PiBwYXRoLmJhc2VuYW1lKGZpbGUpLnRvTG93ZXJDYXNlKCkgPT09IFNVQk1PRF9GSUxFKTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzdWJNb2R1bGVzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGVwbG95ZWRNb2REYXRhKGNvbnRleHQ6IHR5cGVzLklFeHRlbnNpb25Db250ZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Yk1vZHVsZUZpbGVQYXRoczogc3RyaW5nW10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0YU1hbmFnZXI6IENvbU1ldGFkYXRhTWFuYWdlcikge1xuICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLmdldFN0YXRlKCk7XG4gIGNvbnN0IHByb2ZpbGVJZCA9IHNlbGVjdG9ycy5hY3RpdmVQcm9maWxlKHN0YXRlKT8uaWQ7XG4gIGlmIChwcm9maWxlSWQgPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgYXdhaXQgbWV0YU1hbmFnZXIudXBkYXRlRGVwZW5kZW5jeU1hcChwcm9maWxlSWQpO1xuICBjb25zdCBtYW5hZ2VkSWRzID0gYXdhaXQgZ2V0TWFuYWdlZElkcyhjb250ZXh0KTtcblxuICByZXR1cm4gQmx1ZWJpcmQucmVkdWNlKHN1Yk1vZHVsZUZpbGVQYXRocywgYXN5bmMgKGFjY3VtLCBzdWJNb2RGaWxlOiBzdHJpbmcpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZ2V0QXR0clZhbHVlID0gKG5vZGUsIGF0dHIpID0+IG5vZGU/LlthdHRyXT8uWzBdPy4kPy52YWx1ZTtcbiAgICAgIGNvbnN0IHN1Yk1vZERhdGEgPSBhd2FpdCBnZXRYTUxEYXRhKHN1Yk1vZEZpbGUpO1xuICAgICAgY29uc3QgbW9kdWxlID0gc3ViTW9kRGF0YT8uTW9kdWxlO1xuICAgICAgY29uc3Qgc3ViTW9kSWQgPSBnZXRBdHRyVmFsdWUobW9kdWxlLCAnSWQnKTtcbiAgICAgIGNvbnN0IGNvbURlcGVuZGVuY2llcyA9IG1ldGFNYW5hZ2VyLmdldERlcGVuZGVuY2llcyhzdWJNb2RJZCk7XG4gICAgICBjb25zdCBzdWJNb2RWZXJEYXRhID0gZ2V0QXR0clZhbHVlKG1vZHVsZSwgJ1ZlcnNpb24nKTtcbiAgICAgIGNvbnN0IHN1Yk1vZFZlciA9IGdldENsZWFuVmVyc2lvbihzdWJNb2RJZCwgc3ViTW9kVmVyRGF0YSk7XG4gICAgICBjb25zdCBtYW5hZ2VkRW50cnkgPSBtYW5hZ2VkSWRzLmZpbmQoZW50cnkgPT4gZW50cnkuc3ViTW9kSWQgPT09IHN1Yk1vZElkKTtcbiAgICAgIGNvbnN0IGlzTXVsdGlwbGF5ZXIgPSBnZXRBdHRyVmFsdWUobW9kdWxlLCBYTUxfRUxfTVVMVElQTEFZRVIpICE9PSB1bmRlZmluZWQ7XG4gICAgICBjb25zdCBvZmZpY2lhbERlcE5vZGVzID0gbW9kdWxlPy5EZXBlbmRlZE1vZHVsZXM/LlswXT8uRGVwZW5kZWRNb2R1bGUgfHwgW107XG4gICAgICBsZXQgZGVwZW5kZW5jaWVzOiBJRGVwZW5kZW5jeVtdID0gW107XG4gICAgICBjb25zdCBnZXRPZmZpY2lhbERlcE5vZGVzID0gKCkgPT4gb2ZmaWNpYWxEZXBOb2Rlc1xuICAgICAgICAuZmlsdGVyKGRlcE5vZGUgPT4gY29tRGVwZW5kZW5jaWVzLmZpbmQoZGVwID0+IGRlcC5pZCA9PT0gZGVwTm9kZT8uJD8uSWQpID09PSB1bmRlZmluZWQpXG4gICAgICAgIC5tYXAoZGVwTm9kZSA9PiB7XG4gICAgICAgIGxldCBkZXBWZXJzaW9uO1xuICAgICAgICBjb25zdCBkZXBJZCA9IGRlcE5vZGU/LiQ/LklkO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHVuc2FuaXRpemVkID0gZGVwTm9kZT8uJD8uRGVwZW5kZW50VmVyc2lvbjtcbiAgICAgICAgICBkZXBWZXJzaW9uID0gZ2V0Q2xlYW5WZXJzaW9uKHN1Yk1vZElkLCB1bnNhbml0aXplZCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIC8vIERlcGVuZGVudFZlcnNpb24gaXMgYW4gb3B0aW9uYWwgYXR0cmlidXRlLCBpdCdzIG5vdCBhIGJpZyBkZWFsIGlmXG4gICAgICAgICAgLy8gIGl0J3MgbWlzc2luZy5cbiAgICAgICAgICBsb2coJ2RlYnVnJywgJ2ZhaWxlZCB0byByZXNvbHZlIGRlcGVuZGVuY3kgdmVyc2lvbicsIHsgc3ViTW9kSWQsIGVycm9yOiBlcnIubWVzc2FnZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRlcGVuZGVuY3k6IElEZXBlbmRlbmN5ID0ge1xuICAgICAgICAgIGlkOiBkZXBJZCxcbiAgICAgICAgICBpbmNvbXBhdGlibGU6IGZhbHNlLFxuICAgICAgICAgIG9wdGlvbmFsOiBmYWxzZSxcbiAgICAgICAgICBvcmRlcjogJ0xvYWRBZnRlclRoaXMnLFxuICAgICAgICAgIHZlcnNpb246IGRlcFZlcnNpb24sXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIGRlcGVuZGVuY3k7XG4gICAgICB9KTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGRlcGVuZGVuY2llcyA9IChjb21EZXBlbmRlbmNpZXMubGVuZ3RoID4gMClcbiAgICAgICAgICA/IFtdLmNvbmNhdChnZXRPZmZpY2lhbERlcE5vZGVzKCksIGNvbURlcGVuZGVuY2llcylcbiAgICAgICAgICA6IGdldE9mZmljaWFsRGVwTm9kZXMoKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2coJ2RlYnVnJywgJ3N1Ym1vZHVsZSBoYXMgbm8gZGVwZW5kZW5jaWVzIG9yIGlzIGludmFsaWQnLCBlcnIpO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3ViTW9kTmFtZSA9IGdldEF0dHJWYWx1ZShtb2R1bGUsICdOYW1lJyk7XG5cbiAgICAgIGFjY3VtW3N1Yk1vZElkXSA9IHtcbiAgICAgICAgc3ViTW9kSWQsXG4gICAgICAgIHN1Yk1vZE5hbWUsXG4gICAgICAgIHN1Yk1vZFZlcixcbiAgICAgICAgc3ViTW9kRmlsZSxcbiAgICAgICAgdm9ydGV4SWQ6ICEhbWFuYWdlZEVudHJ5ID8gbWFuYWdlZEVudHJ5LnZvcnRleElkIDogc3ViTW9kSWQsXG4gICAgICAgIGlzT2ZmaWNpYWw6IE9GRklDSUFMX01PRFVMRVMuaGFzKHN1Yk1vZElkKSxcbiAgICAgICAgaXNMb2NrZWQ6IExPQ0tFRF9NT0RVTEVTLmhhcyhzdWJNb2RJZCksXG4gICAgICAgIGlzTXVsdGlwbGF5ZXIsXG4gICAgICAgIGRlcGVuZGVuY2llcyxcbiAgICAgICAgaW52YWxpZDoge1xuICAgICAgICAgIC8vIFdpbGwgaG9sZCB0aGUgc3VibW9kIGlkcyBvZiBhbnkgZGV0ZWN0ZWQgY3ljbGljIGRlcGVuZGVuY2llcy5cbiAgICAgICAgICBjeWNsaWM6IFtdLFxuXG4gICAgICAgICAgLy8gV2lsbCBob2xkIHRoZSBzdWJtb2QgaWRzIG9mIGFueSBtaXNzaW5nIGRlcGVuZGVuY2llcy5cbiAgICAgICAgICBtaXNzaW5nOiBbXSxcblxuICAgICAgICAgIC8vIFdpbGwgaG9sZCB0aGUgc3VibW9kIGlkcyBvZiBzdXBwb3NlZGx5IGluY29tcGF0aWJsZSBkZXBlbmRlbmNpZXMgKHZlcnNpb24td2lzZSlcbiAgICAgICAgICBpbmNvbXBhdGlibGVEZXBzOiBbXSxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSAnVm9ydGV4IHdhcyB1bmFibGUgdG8gcGFyc2U6ICcgKyBzdWJNb2RGaWxlICsgJztcXG5cXG4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgKyAnWW91IGNhbiBlaXRoZXIgaW5mb3JtIHRoZSBtb2QgYXV0aG9yIGFuZCB3YWl0IGZvciBmaXgsIG9yICdcbiAgICAgICAgICAgICAgICAgICAgICAgICArICd5b3UgY2FuIHVzZSBhbiBvbmxpbmUgeG1sIHZhbGlkYXRvciB0byBmaW5kIGFuZCBmaXggdGhlICdcbiAgICAgICAgICAgICAgICAgICAgICAgICArICdlcnJvciB5b3Vyc2VsZi4nO1xuICAgICAgY29udGV4dC5hcGkuc2hvd0Vycm9yTm90aWZpY2F0aW9uKCdVbmFibGUgdG8gcGFyc2Ugc3VibW9kdWxlIGZpbGUnLFxuICAgICAgICBlcnJvck1lc3NhZ2UsIHsgYWxsb3dSZXBvcnQ6IGZhbHNlIH0pO1xuICAgICAgbG9nKCdlcnJvcicsICdNTkIyOiBwYXJzaW5nIGVycm9yJywgZXJyKTtcbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhY2N1bSk7XG4gIH0sIHt9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBhcnNlTGF1bmNoZXJEYXRhKCkge1xuICBjb25zdCBjcmVhdGVEYXRhRWxlbWVudCA9ICh4bWxOb2RlKSA9PiB7XG4gICAgaWYgKHhtbE5vZGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Yk1vZElkOiB4bWxOb2RlPy5JZFswXSxcbiAgICAgIGVuYWJsZWQ6IHhtbE5vZGU/LklzU2VsZWN0ZWRbMF0gPT09ICd0cnVlJyxcbiAgICB9O1xuICB9O1xuXG4gIGNvbnN0IGxhdW5jaGVyRGF0YSA9IGF3YWl0IGdldFhNTERhdGEoTEFVTkNIRVJfREFUQV9QQVRIKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBzaW5nbGVQbGF5ZXJNb2RzID0gbGF1bmNoZXJEYXRhPy5Vc2VyRGF0YT8uU2luZ2xlcGxheWVyRGF0YT8uWzBdPy5Nb2REYXRhcz8uWzBdPy5Vc2VyTW9kRGF0YSB8fCBbXTtcbiAgICBjb25zdCBtdWx0aVBsYXllck1vZHMgPSBsYXVuY2hlckRhdGE/LlVzZXJEYXRhPy5NdWx0aXBsYXllckRhdGE/LlswXT8uTW9kRGF0YXM/LlswXT8uVXNlck1vZERhdGEgfHwgW107XG4gICAgTEFVTkNIRVJfREFUQS5zaW5nbGVQbGF5ZXJTdWJNb2RzID0gc2luZ2xlUGxheWVyTW9kcy5yZWR1Y2UoKGFjY3VtLCBzcG0pID0+IHtcbiAgICAgIGNvbnN0IGRhdGFFbGVtZW50ID0gY3JlYXRlRGF0YUVsZW1lbnQoc3BtKTtcbiAgICAgIGlmICghIWRhdGFFbGVtZW50KSB7XG4gICAgICAgIGFjY3VtLnB1c2goZGF0YUVsZW1lbnQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjY3VtO1xuICAgIH0sIFtdKTtcbiAgICBMQVVOQ0hFUl9EQVRBLm11bHRpcGxheWVyU3ViTW9kcyA9IG11bHRpUGxheWVyTW9kcy5yZWR1Y2UoKGFjY3VtLCBtcG0pID0+IHtcbiAgICAgIGNvbnN0IGRhdGFFbGVtZW50ID0gY3JlYXRlRGF0YUVsZW1lbnQobXBtKTtcbiAgICAgIGlmICghIWRhdGFFbGVtZW50KSB7XG4gICAgICAgIGFjY3VtLnB1c2goZGF0YUVsZW1lbnQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjY3VtO1xuICAgIH0sIFtdKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gVGhpcyBpcyBwb3RlbnRpYWxseSBkdWUgdG8gdGhlIGdhbWUgbm90IGJlaW5nIGluc3RhbGxlZCBjb3JyZWN0bHlcbiAgICAvLyAgb3IgcGVyaGFwcyB0aGUgdXNlcnMgYXJlIHVzaW5nIGEgM3JkIHBhcnR5IGxhdW5jaGVyIHdoaWNoIG92ZXJ3cml0ZXNcbiAgICAvLyAgdGhlIGRlZmF1bHQgbGF1bmNoZXIgY29uZmlndXJhdGlvbi4uLiBMZXRzIGp1c3QgZGVmYXVsdCB0byB0aGUgZGF0YVxuICAgIC8vICB3ZSBleHBlY3QgYW5kIGxldCB0aGUgdXNlciBkZWFsIHdpdGggd2hhdGV2ZXIgaXMgYnJva2VuIGxhdGVyIG9uXG4gICAgLy8gIGhpcyBlbnZpcm9ubWVudCBsYXRlci5cbiAgICBsb2coJ2Vycm9yJywgJ2ZhaWxlZCB0byBwYXJzZSBsYXVuY2hlciBkYXRhJywgZXJyKTtcbiAgICBMQVVOQ0hFUl9EQVRBLnNpbmdsZVBsYXllclN1Yk1vZHMgPSBbXG4gICAgICB7IHN1Yk1vZElkOiAnTmF0aXZlJywgZW5hYmxlZDogdHJ1ZSB9LFxuICAgICAgeyBzdWJNb2RJZDogJ1NhbmRCb3hDb3JlJywgZW5hYmxlZDogdHJ1ZSB9LFxuICAgICAgeyBzdWJNb2RJZDogJ0N1c3RvbUJhdHRsZScsIGVuYWJsZWQ6IHRydWUgfSxcbiAgICAgIHsgc3ViTW9kSWQ6ICdTYW5kYm94JywgZW5hYmxlZDogdHJ1ZSB9LFxuICAgICAgeyBzdWJNb2RJZDogJ1N0b3J5TW9kZScsIGVuYWJsZWQ6IHRydWUgfSxcbiAgICBdO1xuICAgIExBVU5DSEVSX0RBVEEubXVsdGlwbGF5ZXJTdWJNb2RzID0gW107XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE1hbmFnZWRJZHMoY29udGV4dDogdHlwZXMuSUV4dGVuc2lvbkNvbnRleHQpIHtcbiAgY29uc3Qgc3RhdGUgPSBjb250ZXh0LmFwaS5zdG9yZS5nZXRTdGF0ZSgpO1xuICBjb25zdCBhY3RpdmVQcm9maWxlID0gc2VsZWN0b3JzLmFjdGl2ZVByb2ZpbGUoc3RhdGUpO1xuICBpZiAoYWN0aXZlUHJvZmlsZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgLy8gVGhpcyBpcyBhIHZhbGlkIHVzZSBjYXNlIGlmIHRoZSBnYW1lbW9kZVxuICAgIC8vICBoYXMgZmFpbGVkIGFjdGl2YXRpb24uXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XG4gIH1cblxuICBjb25zdCBtb2RTdGF0ZSA9IHN0YXRlPy5wZXJzaXN0ZW50Py5wcm9maWxlcz8uW2FjdGl2ZVByb2ZpbGUuaWRdPy5tb2RTdGF0ZSA/PyB7fTtcbiAgY29uc3QgbW9kcyA9IHN0YXRlPy5wZXJzaXN0ZW50Py5tb2RzPy5bR0FNRV9JRF0gPz8ge307XG4gIGNvbnN0IGVuYWJsZWRNb2RzID0gT2JqZWN0LmtleXMobW9kU3RhdGUpXG4gICAgLmZpbHRlcihrZXkgPT4gISFtb2RzW2tleV0gJiYgbW9kU3RhdGVba2V5XS5lbmFibGVkKVxuICAgIC5tYXAoa2V5ID0+IG1vZHNba2V5XSk7XG5cbiAgY29uc3QgaW52YWxpZE1vZHMgPSBbXTtcbiAgY29uc3QgaW5zdGFsbGF0aW9uRGlyID0gc2VsZWN0b3JzLmluc3RhbGxQYXRoRm9yR2FtZShzdGF0ZSwgR0FNRV9JRCk7XG4gIGlmIChpbnN0YWxsYXRpb25EaXIgPT09IHVuZGVmaW5lZCkge1xuICAgIGxvZygnZXJyb3InLCAnZmFpbGVkIHRvIGdldCBtYW5hZ2VkIGlkcycsICd1bmRlZmluZWQgc3RhZ2luZyBmb2xkZXInKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKTtcbiAgfVxuICByZXR1cm4gQmx1ZWJpcmQucmVkdWNlKGVuYWJsZWRNb2RzLCBhc3luYyAoYWNjdW0sIGVudHJ5KSA9PiB7XG4gICAgaWYgKGVudHJ5Py5pbnN0YWxsYXRpb25QYXRoID09PSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIEludmFsaWQgbW9kIGVudHJ5IC0gc2tpcCBpdC5cbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYWNjdW0pO1xuICAgIH1cbiAgICBjb25zdCBtb2RJbnN0YWxsYXRpb25QYXRoID0gcGF0aC5qb2luKGluc3RhbGxhdGlvbkRpciwgZW50cnkuaW5zdGFsbGF0aW9uUGF0aCk7XG4gICAgbGV0IGZpbGVzO1xuICAgIHRyeSB7XG4gICAgICBmaWxlcyA9IGF3YWl0IHdhbGtBc3luYyhtb2RJbnN0YWxsYXRpb25QYXRoLCAzKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIFRoZSBtb2QgbXVzdCd2ZSBiZWVuIHJlbW92ZWQgbWFudWFsbHkgYnkgdGhlIHVzZXIgZnJvbVxuICAgICAgLy8gIHRoZSBzdGFnaW5nIGZvbGRlciAtIGdvb2Qgam9iIGJ1ZGR5IVxuICAgICAgLy8gIEdvaW5nIHRvIGxvZyB0aGlzLCBidXQgb3RoZXJ3aXNlIGFsbG93IGl0IHRvIHByb2NlZWQuXG4gICAgICBpbnZhbGlkTW9kcy5wdXNoKGVudHJ5LmlkKTtcbiAgICAgIGxvZygnZXJyb3InLCAnZmFpbGVkIHRvIHJlYWQgbW9kIHN0YWdpbmcgZm9sZGVyJywgeyBtb2RJZDogZW50cnkuaWQsIGVycm9yOiBlcnIubWVzc2FnZSB9KTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYWNjdW0pO1xuICAgIH1cblxuICAgIGNvbnN0IHN1Yk1vZEZpbGUgPSBmaWxlcy5maW5kKGZpbGUgPT4gcGF0aC5iYXNlbmFtZShmaWxlKS50b0xvd2VyQ2FzZSgpID09PSBTVUJNT0RfRklMRSk7XG4gICAgaWYgKHN1Yk1vZEZpbGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gTm8gc3VibW9kIGZpbGUgLSBubyBMT1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhY2N1bSk7XG4gICAgfVxuXG4gICAgbGV0IHN1Yk1vZElkO1xuICAgIHRyeSB7XG4gICAgICBzdWJNb2RJZCA9IGF3YWl0IGdldEVsZW1lbnRWYWx1ZShzdWJNb2RGaWxlLCAnSWQnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIFRoZSBzdWJtb2R1bGUgd291bGQndmUgbmV2ZXIgbWFuYWdlZCB0byBpbnN0YWxsIGNvcnJlY3RseVxuICAgICAgLy8gIGlmIHRoZSB4bWwgZmlsZSBoYWQgYmVlbiBpbnZhbGlkIC0gdGhpcyBzdWdnZXN0cyB0aGF0IHRoZSB1c2VyXG4gICAgICAvLyAgb3IgYSAzcmQgcGFydHkgYXBwbGljYXRpb24gaGFzIHRhbXBlcmVkIHdpdGggdGhlIGZpbGUuLi5cbiAgICAgIC8vICBXZSBzaW1wbHkgbG9nIHRoaXMgaGVyZSBhcyB0aGUgcGFyc2UtaW5nIGZhaWx1cmUgd2lsbCBiZSBoaWdobGlnaHRlZFxuICAgICAgLy8gIGJ5IHRoZSBDQUNIRSBsb2dpYy5cbiAgICAgIGxvZygnZXJyb3InLCAnW01uQjJdIFVuYWJsZSB0byBwYXJzZSBzdWJtb2R1bGUgZmlsZScsIGVycik7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFjY3VtKTtcbiAgICB9XG4gICAgYWNjdW0ucHVzaCh7XG4gICAgICBzdWJNb2RJZCxcbiAgICAgIHN1Yk1vZEZpbGUsXG4gICAgICB2b3J0ZXhJZDogZW50cnkuaWQsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFjY3VtKTtcbiAgfSwgW10pXG4gIC50YXAoKHJlcykgPT4ge1xuICAgIGlmIChpbnZhbGlkTW9kcy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBlcnJNZXNzYWdlID0gJ1RoZSBmb2xsb3dpbmcgbW9kcyBhcmUgaW5hY2Nlc3NpYmxlIG9yIGFyZSBtaXNzaW5nICdcbiAgICAgICAgKyAnaW4gdGhlIHN0YWdpbmcgZm9sZGVyOlxcblxcbicgKyBpbnZhbGlkTW9kcy5qb2luKCdcXG4nKSArICdcXG5cXG5QbGVhc2UgZW5zdXJlICdcbiAgICAgICAgKyAndGhlc2UgbW9kcyBhbmQgdGhlaXIgY29udGVudCBhcmUgbm90IG9wZW4gaW4gYW55IG90aGVyIGFwcGxpY2F0aW9uICdcbiAgICAgICAgKyAnKGluY2x1ZGluZyB0aGUgZ2FtZSBpdHNlbGYpLiBJZiB0aGUgbW9kIGlzIG1pc3NpbmcgZW50aXJlbHksIHBsZWFzZSByZS1pbnN0YWxsIGl0ICdcbiAgICAgICAgKyAnb3IgcmVtb3ZlIGl0IGZyb20geW91ciBtb2RzIHBhZ2UuIFBsZWFzZSBjaGVjayB5b3VyIHZvcnRleCBsb2cgZmlsZSBmb3IgZGV0YWlscy4nO1xuICAgICAgY29udGV4dC5hcGkuc2hvd0Vycm9yTm90aWZpY2F0aW9uKCdJbnZhbGlkIE1vZHMgaW4gU3RhZ2luZycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IEVycm9yKGVyck1lc3NhZ2UpLCB7IGFsbG93UmVwb3J0OiBmYWxzZSB9KTtcbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXMpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzSW52YWxpZChzdWJNb2RJZDogc3RyaW5nKSB7XG4gIGNvbnN0IGN5Y2xpY0Vycm9ycyA9IENBQ0hFW3N1Yk1vZElkXT8uaW52YWxpZD8uY3ljbGljID8/IFtdO1xuICBjb25zdCBtaXNzaW5nRGVwcyA9IENBQ0hFW3N1Yk1vZElkXT8uaW52YWxpZD8ubWlzc2luZyA/PyBbXTtcbiAgcmV0dXJuICgoY3ljbGljRXJyb3JzLmxlbmd0aCA+IDApIHx8IChtaXNzaW5nRGVwcy5sZW5ndGggPiAwKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRWYWxpZGF0aW9uSW5mbyh2b3J0ZXhJZDogc3RyaW5nKSB7XG4gIC8vIFdlIGV4cGVjdCB0aGUgbWV0aG9kIGNhbGxlciB0byBwcm92aWRlIHRoZSB2b3J0ZXhJZCBvZiB0aGUgc3ViTW9kLCBhc1xuICAvLyAgdGhpcyBpcyBob3cgd2Ugc3RvcmUgdGhpcyBpbmZvcm1hdGlvbiBpbiB0aGUgbG9hZCBvcmRlciBvYmplY3QuXG4gIC8vICBSZWFzb24gd2h5IHdlIG5lZWQgdG8gc2VhcmNoIHRoZSBjYWNoZSBieSB2b3J0ZXhJZCByYXRoZXIgdGhhbiBzdWJNb2RJZC5cbiAgY29uc3Qgc3ViTW9kSWQgPSBPYmplY3Qua2V5cyhDQUNIRSkuZmluZChrZXkgPT4gQ0FDSEVba2V5XS52b3J0ZXhJZCA9PT0gdm9ydGV4SWQpO1xuICBjb25zdCBjeWNsaWMgPSBDQUNIRVtzdWJNb2RJZF0/LmludmFsaWQ/LmN5Y2xpYyA/PyBbXTtcbiAgY29uc3QgbWlzc2luZyA9IENBQ0hFW3N1Yk1vZElkXT8uaW52YWxpZD8ubWlzc2luZyA/PyBbXTtcbiAgY29uc3QgaW5jb21wYXRpYmxlID0gQ0FDSEVbc3ViTW9kSWRdPy5pbnZhbGlkPy5pbmNvbXBhdGlibGVEZXBzID8/IFtdO1xuICByZXR1cm4ge1xuICAgIGN5Y2xpYyxcbiAgICBtaXNzaW5nLFxuICAgIGluY29tcGF0aWJsZSxcbiAgfTtcbn1cbiJdfQ==