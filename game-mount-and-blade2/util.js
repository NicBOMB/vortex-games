"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.walkAsync = exports.getCleanVersion = exports.refreshGameParams = exports.getElementValue = exports.genProps = exports.getXMLData = void 0;
const bluebird_1 = __importDefault(require("bluebird"));
const path_1 = __importDefault(require("path"));
const semver_1 = __importDefault(require("semver"));
const vortex_api_1 = require("vortex-api");
const xml2js_1 = require("xml2js");
const common_1 = require("./common");
const subModCache_1 = require("./subModCache");
const PARAMS_TEMPLATE = ['/{{gameMode}}', '_MODULES_{{subModIds}}*_MODULES_'];
async function getXMLData(xmlFilePath) {
    return vortex_api_1.fs.readFileAsync(xmlFilePath)
        .then(async (data) => {
        try {
            const xmlData = await (0, xml2js_1.parseStringPromise)(data);
            return Promise.resolve(xmlData);
        }
        catch (err) {
            return Promise.reject(new vortex_api_1.util.DataInvalid(err.message));
        }
    })
        .catch(err => (err.code === 'ENOENT')
        ? Promise.reject(new vortex_api_1.util.NotFound(xmlFilePath))
        : Promise.reject(new vortex_api_1.util.DataInvalid(err.message)));
}
exports.getXMLData = getXMLData;
function genProps(api, profileId) {
    const state = api.getState();
    const profile = (profileId !== undefined)
        ? vortex_api_1.selectors.profileById(state, profileId)
        : vortex_api_1.selectors.activeProfile(state);
    if (profile?.gameId !== common_1.GAME_ID) {
        return undefined;
    }
    const discovery = state?.settings?.gameMode?.discovered?.[common_1.GAME_ID];
    if (discovery?.path === undefined) {
        return undefined;
    }
    const mods = state?.persistent?.mods?.[common_1.GAME_ID] ?? {};
    const enabledMods = Object.keys(mods)
        .filter(id => profile?.modState?.[id]?.enabled ?? false)
        .reduce((accum, id) => {
        accum[id] = mods[id];
        return accum;
    }, {});
    return { state, profile, discovery, enabledMods };
}
exports.genProps = genProps;
async function getElementValue(subModuleFilePath, elementName) {
    const logAndContinue = () => {
        (0, vortex_api_1.log)('error', 'Unable to parse xml element', elementName);
        return Promise.resolve(undefined);
    };
    return vortex_api_1.fs.readFileAsync(subModuleFilePath, { encoding: 'utf-8' })
        .then(async (xmlData) => {
        try {
            const modInfo = await (0, xml2js_1.parseStringPromise)(xmlData);
            const element = modInfo?.Module?.[elementName];
            return ((element !== undefined) && (element?.[0]?.$?.value !== undefined))
                ? Promise.resolve(element?.[0]?.$?.value)
                : logAndContinue();
        }
        catch (err) {
            const errorMessage = 'Vortex was unable to parse: ' + subModuleFilePath + '; please inform the mod author';
            return Promise.reject(new vortex_api_1.util.DataInvalid(errorMessage));
        }
    });
}
exports.getElementValue = getElementValue;
async function refreshGameParams(context, loadOrder) {
    const LAUNCHER_DATA = (0, subModCache_1.getLauncherData)();
    const enabled = (!!loadOrder && Object.keys(loadOrder).length > 0)
        ? Object.keys(loadOrder)
            .filter(key => loadOrder[key].enabled)
            .sort((lhs, rhs) => loadOrder[lhs].pos - loadOrder[rhs].pos)
            .reduce((accum, key) => {
            const CACHE = (0, subModCache_1.getCache)();
            const cacheKeys = Object.keys(CACHE);
            const entry = cacheKeys.find(cacheElement => CACHE[cacheElement].vortexId === key);
            if (!!entry) {
                accum.push(entry);
            }
            return accum;
        }, [])
        : LAUNCHER_DATA.singlePlayerSubMods
            .filter(subMod => subMod.enabled)
            .map(subMod => subMod.subModId);
    const parameters = [
        PARAMS_TEMPLATE[0].replace('{{gameMode}}', 'singleplayer'),
        PARAMS_TEMPLATE[1].replace('{{subModIds}}', enabled.map(key => `*${key}`).join('')),
    ];
    context.api.store.dispatch(vortex_api_1.actions.setGameParameters(common_1.GAME_ID, {
        executable: common_1.BANNERLORD_EXEC,
        parameters,
    }));
    return Promise.resolve();
}
exports.refreshGameParams = refreshGameParams;
function getCleanVersion(subModId, unsanitized) {
    if (!unsanitized) {
        (0, vortex_api_1.log)('debug', 'failed to sanitize/coerce version', { subModId, unsanitized });
        return undefined;
    }
    try {
        const sanitized = unsanitized.replace(/[a-z]|[A-Z]/g, '');
        const coerced = semver_1.default.coerce(sanitized);
        return coerced.version;
    }
    catch (err) {
        (0, vortex_api_1.log)('debug', 'failed to sanitize/coerce version', { subModId, unsanitized, error: err.message });
        return undefined;
    }
}
exports.getCleanVersion = getCleanVersion;
async function walkAsync(dir, levelsDeep = 2) {
    let entries = [];
    return vortex_api_1.fs.readdirAsync(dir).then(files => {
        const filtered = files.filter(file => !file.endsWith('.vortex_backup'));
        return bluebird_1.default.each(filtered, file => {
            const fullPath = path_1.default.join(dir, file);
            return vortex_api_1.fs.statAsync(fullPath).then(stats => {
                if (stats.isDirectory() && levelsDeep > 0) {
                    return walkAsync(fullPath, levelsDeep - 1)
                        .then(nestedFiles => {
                        entries = entries.concat(nestedFiles);
                        return Promise.resolve();
                    });
                }
                else {
                    entries.push(fullPath);
                    return Promise.resolve();
                }
            }).catch(err => {
                (0, vortex_api_1.log)('error', 'MnB2: invalid symlink', err);
                return (err.code === 'ENOENT')
                    ? Promise.resolve()
                    : Promise.reject(err);
            });
        });
    })
        .then(() => Promise.resolve(entries));
}
exports.walkAsync = walkAsync;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0RBQWdDO0FBQ2hDLGdEQUF3QjtBQUN4QixvREFBNEI7QUFDNUIsMkNBQXNFO0FBQ3RFLG1DQUE0QztBQUU1QyxxQ0FBb0Q7QUFDcEQsK0NBQTBEO0FBTTFELE1BQU0sZUFBZSxHQUFHLENBQUMsZUFBZSxFQUFFLGtDQUFrQyxDQUFDLENBQUM7QUFFdkUsS0FBSyxVQUFVLFVBQVUsQ0FBQyxXQUFtQjtJQUNsRCxPQUFPLGVBQUUsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDO1NBQ2pDLElBQUksQ0FBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEVBQUU7UUFDakIsSUFBSTtZQUNGLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBQSwyQkFBa0IsRUFBQyxJQUFJLENBQUMsQ0FBQztZQUMvQyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDakM7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLGlCQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzFEO0lBQ0gsQ0FBQyxDQUFDO1NBQ0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQztRQUNuQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLGlCQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2hELENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksaUJBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMzRCxDQUFDO0FBYkQsZ0NBYUM7QUFFRCxTQUFnQixRQUFRLENBQUMsR0FBd0IsRUFBRSxT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Q0FBQyxFQUFFO2dCQUliLElBQUEsZ0JBQUcsRUFBQyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQzNDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQztvQkFDNUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7b0JBQ25CLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzFCLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUM7U0FDRCxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQ3hDLENBQUM7QUE3QkQsOEJBNkJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJsdWViaXJkIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0IHsgYWN0aW9ucywgZnMsIGxvZywgc2VsZWN0b3JzLCB0eXBlcywgdXRpbCB9IGZyb20gJ3ZvcnRleC1hcGknO1xuaW1wb3J0IHsgcGFyc2VTdHJpbmdQcm9taXNlIH0gZnJvbSAneG1sMmpzJztcblxuaW1wb3J0IHsgQkFOTkVSTE9SRF9FWEVDLCBHQU1FX0lEIH0gZnJvbSAnLi9jb21tb24nO1xuaW1wb3J0IHsgZ2V0Q2FjaGUsIGdldExhdW5jaGVyRGF0YSB9IGZyb20gJy4vc3ViTW9kQ2FjaGUnO1xuaW1wb3J0IHsgSUxvYWRPcmRlciwgSVByb3BzIH0gZnJvbSAnLi90eXBlcyc7XG5cbi8vIFVzZWQgZm9yIHRoZSBcImN1c3RvbSBsYXVuY2hlclwiIHRvb2xzLlxuLy8gIGdhbWVNb2RlOiBzaW5nbGVwbGF5ZXIgb3IgbXVsdGlwbGF5ZXJcbi8vICBzdWJNb2RJZHM6IHRoZSBtb2QgaWRzIHdlIHdhbnQgdG8gbG9hZCBpbnRvIHRoZSBnYW1lLlxuY29uc3QgUEFSQU1TX1RFTVBMQVRFID0gWycve3tnYW1lTW9kZX19JywgJ19NT0RVTEVTX3t7c3ViTW9kSWRzfX0qX01PRFVMRVNfJ107XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRYTUxEYXRhKHhtbEZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGZzLnJlYWRGaWxlQXN5bmMoeG1sRmlsZVBhdGgpXG4gICAgLnRoZW4oYXN5bmMgZGF0YSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB4bWxEYXRhID0gYXdhaXQgcGFyc2VTdHJpbmdQcm9taXNlKGRhdGEpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHhtbERhdGEpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgdXRpbC5EYXRhSW52YWxpZChlcnIubWVzc2FnZSkpO1xuICAgICAgfVxuICAgIH0pXG4gICAgLmNhdGNoKGVyciA9PiAoZXJyLmNvZGUgPT09ICdFTk9FTlQnKVxuICAgICAgPyBQcm9taXNlLnJlamVjdChuZXcgdXRpbC5Ob3RGb3VuZCh4bWxGaWxlUGF0aCkpXG4gICAgICA6IFByb21pc2UucmVqZWN0KG5ldyB1dGlsLkRhdGFJbnZhbGlkKGVyci5tZXNzYWdlKSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2VuUHJvcHMoYXBpOiB0eXBlcy5JRXh0ZW5zaW9uQXBpLCBwcm9maWxlSWQ/OiBzdHJpbmcpOiBJUHJvcHMge1xuICBjb25zdCBzdGF0ZSA9IGFwaS5nZXRTdGF0ZSgpO1xuICBjb25zdCBwcm9maWxlID0gKHByb2ZpbGVJZCAhPT0gdW5kZWZpbmVkKVxuICAgID8gc2VsZWN0b3JzLnByb2ZpbGVCeUlkKHN0YXRlLCBwcm9maWxlSWQpXG4gICAgOiBzZWxlY3RvcnMuYWN0aXZlUHJvZmlsZShzdGF0ZSk7XG5cbiAgaWYgKHByb2ZpbGU/LmdhbWVJZCAhPT0gR0FNRV9JRCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBkaXNjb3ZlcnkgPSBzdGF0ZT8uc2V0dGluZ3M/LmdhbWVNb2RlPy5kaXNjb3ZlcmVkPy5bR0FNRV9JRF07XG4gIGlmIChkaXNjb3Zlcnk/LnBhdGggPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBtb2RzID0gc3RhdGU/LnBlcnNpc3RlbnQ/Lm1vZHM/LltHQU1FX0lEXSA/PyB7fTtcblxuICBjb25zdCBlbmFibGVkTW9kcyA9IE9iamVjdC5rZXlzKG1vZHMpXG4gICAgLmZpbHRlcihpZCA9PiBwcm9maWxlPy5tb2RTdGF0ZT8uW2lkXT8uZW5hYmxlZCA/PyBmYWxzZSlcbiAgICAucmVkdWNlKChhY2N1bSwgaWQpID0+IHtcbiAgICAgIGFjY3VtW2lkXSA9IG1vZHNbaWRdO1xuICAgICAgcmV0dXJuIGFjY3VtO1xuICAgIH0sIHt9KTtcblxuICByZXR1cm4geyBzdGF0ZSwgcHJvZmlsZSwgZGlzY292ZXJ5LCBlbmFibGVkTW9kcyB9O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RWxlbWVudFZhbHVlKHN1Yk1vZHVsZUZpbGVQYXRoOiBzdHJpbmcsIGVsZW1lbnROYW1lOiBzdHJpbmcpIHtcbiAgY29uc3QgbG9nQW5kQ29udGludWUgPSAoKSA9PiB7XG4gICAgbG9nKCdlcnJvcicsICdVbmFibGUgdG8gcGFyc2UgeG1sIGVsZW1lbnQnLCBlbGVtZW50TmFtZSk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpO1xuICB9O1xuICByZXR1cm4gZnMucmVhZEZpbGVBc3luYyhzdWJNb2R1bGVGaWxlUGF0aCwgeyBlbmNvZGluZzogJ3V0Zi04JyB9KVxuICAgIC50aGVuKGFzeW5jIHhtbERhdGEgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbW9kSW5mbyA9IGF3YWl0IHBhcnNlU3RyaW5nUHJvbWlzZSh4bWxEYXRhKTtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IG1vZEluZm8/Lk1vZHVsZT8uW2VsZW1lbnROYW1lXTtcbiAgICAgICAgcmV0dXJuICgoZWxlbWVudCAhPT0gdW5kZWZpbmVkKSAmJiAoZWxlbWVudD8uWzBdPy4kPy52YWx1ZSAhPT0gdW5kZWZpbmVkKSlcbiAgICAgICAgICA/IFByb21pc2UucmVzb2x2ZShlbGVtZW50Py5bMF0/LiQ/LnZhbHVlKVxuICAgICAgICAgIDogbG9nQW5kQ29udGludWUoKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSAnVm9ydGV4IHdhcyB1bmFibGUgdG8gcGFyc2U6ICcgKyBzdWJNb2R1bGVGaWxlUGF0aCArICc7IHBsZWFzZSBpbmZvcm0gdGhlIG1vZCBhdXRob3InO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IHV0aWwuRGF0YUludmFsaWQoZXJyb3JNZXNzYWdlKSk7XG4gICAgICB9XG4gICAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWZyZXNoR2FtZVBhcmFtcyhjb250ZXh0OiB0eXBlcy5JRXh0ZW5zaW9uQ29udGV4dCwgbG9hZE9yZGVyOiBJTG9hZE9yZGVyKSB7XG4gIGNvbnN0IExBVU5DSEVSX0RBVEEgPSBnZXRMYXVuY2hlckRhdGEoKTtcbiAgLy8gR28gdGhyb3VnaCB0aGUgZW5hYmxlZCBlbnRyaWVzIHNvIHdlIGNhbiBmb3JtIG91ciBnYW1lIHBhcmFtZXRlcnMuXG4gIGNvbnN0IGVuYWJsZWQgPSAoISFsb2FkT3JkZXIgJiYgT2JqZWN0LmtleXMobG9hZE9yZGVyKS5sZW5ndGggPiAwKVxuICAgID8gT2JqZWN0LmtleXMobG9hZE9yZGVyKVxuICAgICAgICAuZmlsdGVyKGtleSA9PiBsb2FkT3JkZXJba2V5XS5lbmFibGVkKVxuICAgICAgICAuc29ydCgobGhzLCByaHMpID0+IGxvYWRPcmRlcltsaHNdLnBvcyAtIGxvYWRPcmRlcltyaHNdLnBvcylcbiAgICAgICAgLnJlZHVjZSgoYWNjdW0sIGtleSkgPT4ge1xuICAgICAgICAgIGNvbnN0IENBQ0hFID0gZ2V0Q2FjaGUoKTtcbiAgICAgICAgICBjb25zdCBjYWNoZUtleXMgPSBPYmplY3Qua2V5cyhDQUNIRSk7XG4gICAgICAgICAgY29uc3QgZW50cnkgPSBjYWNoZUtleXMuZmluZChjYWNoZUVsZW1lbnQgPT4gQ0FDSEVbY2FjaGVFbGVtZW50XS52b3J0ZXhJZCA9PT0ga2V5KTtcbiAgICAgICAgICBpZiAoISFlbnRyeSkge1xuICAgICAgICAgICAgYWNjdW0ucHVzaChlbnRyeSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBhY2N1bTtcbiAgICAgICAgfSwgW10pXG4gICAgOiBMQVVOQ0hFUl9EQVRBLnNpbmdsZVBsYXllclN1Yk1vZHNcbiAgICAgICAgLmZpbHRlcihzdWJNb2QgPT4gc3ViTW9kLmVuYWJsZWQpXG4gICAgICAgIC5tYXAoc3ViTW9kID0+IHN1Yk1vZC5zdWJNb2RJZCk7XG5cbiAgLy8gQ3VycmVudGx5IFNpbmdsZXBsYXllciBvbmx5ISAobW9yZSByZXNlYXJjaCBpbnRvIE1QIG5lZWRzIHRvIGJlIGRvbmUpXG4gIGNvbnN0IHBhcmFtZXRlcnMgPSBbXG4gICAgUEFSQU1TX1RFTVBMQVRFWzBdLnJlcGxhY2UoJ3t7Z2FtZU1vZGV9fScsICdzaW5nbGVwbGF5ZXInKSxcbiAgICBQQVJBTVNfVEVNUExBVEVbMV0ucmVwbGFjZSgne3tzdWJNb2RJZHN9fScsIGVuYWJsZWQubWFwKGtleSA9PiBgKiR7a2V5fWApLmpvaW4oJycpKSxcbiAgXTtcblxuICAvLyBUaGlzIGxhdW5jaGVyIHdpbGwgbm90IGZ1bmN0aW9uIHVubGVzcyB0aGUgcGF0aCBpcyBndWFyYW50ZWVkIHRvIHBvaW50XG4gIC8vICB0b3dhcmRzIHRoZSBiYW5uZXJsb3JkIGV4ZWN1dGFibGUuIEdpdmVuIHRoYXQgZWFybGllciB2ZXJzaW9ucyBvZiB0aGlzXG4gIC8vICBleHRlbnNpb24gaGFkIHRhcmdldGVkIFRhbGVXb3JsZHMuTGF1bmNoZXIuZXhlIGluc3RlYWQgLSB3ZSBuZWVkIHRvIG1ha2VcbiAgLy8gIHN1cmUgdGhpcyBpcyBzZXQgY29ycmVjdGx5LlxuICBjb250ZXh0LmFwaS5zdG9yZS5kaXNwYXRjaChhY3Rpb25zLnNldEdhbWVQYXJhbWV0ZXJzKEdBTUVfSUQsIHtcbiAgICBleGVjdXRhYmxlOiBCQU5ORVJMT1JEX0VYRUMsXG4gICAgcGFyYW1ldGVycyxcbiAgfSkpO1xuXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENsZWFuVmVyc2lvbihzdWJNb2RJZDogc3RyaW5nLCB1bnNhbml0aXplZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgaWYgKCF1bnNhbml0aXplZCkge1xuICAgIGxvZygnZGVidWcnLCAnZmFpbGVkIHRvIHNhbml0aXplL2NvZXJjZSB2ZXJzaW9uJywgeyBzdWJNb2RJZCwgdW5zYW5pdGl6ZWQgfSk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHNhbml0aXplZCA9IHVuc2FuaXRpemVkLnJlcGxhY2UoL1thLXpdfFtBLVpdL2csICcnKTtcbiAgICBjb25zdCBjb2VyY2VkID0gc2VtdmVyLmNvZXJjZShzYW5pdGl6ZWQpO1xuICAgIHJldHVybiBjb2VyY2VkLnZlcnNpb247XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZygnZGVidWcnLCAnZmFpbGVkIHRvIHNhbml0aXplL2NvZXJjZSB2ZXJzaW9uJyxcbiAgICAgIHsgc3ViTW9kSWQsIHVuc2FuaXRpemVkLCBlcnJvcjogZXJyLm1lc3NhZ2UgfSk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2Fsa0FzeW5jKGRpciwgbGV2ZWxzRGVlcCA9IDIpIHtcbiAgbGV0IGVudHJpZXMgPSBbXTtcbiAgcmV0dXJuIGZzLnJlYWRkaXJBc3luYyhkaXIpLnRoZW4oZmlsZXMgPT4ge1xuICAgIGNvbnN0IGZpbHRlcmVkID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gIWZpbGUuZW5kc1dpdGgoJy52b3J0ZXhfYmFja3VwJykpO1xuICAgIHJldHVybiBCbHVlYmlyZC5lYWNoKGZpbHRlcmVkLCBmaWxlID0+IHtcbiAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5qb2luKGRpciwgZmlsZSk7XG4gICAgICByZXR1cm4gZnMuc3RhdEFzeW5jKGZ1bGxQYXRoKS50aGVuKHN0YXRzID0+IHtcbiAgICAgICAgaWYgKHN0YXRzLmlzRGlyZWN0b3J5KCkgJiYgbGV2ZWxzRGVlcCA+IDApIHtcbiAgICAgICAgICByZXR1cm4gd2Fsa0FzeW5jKGZ1bGxQYXRoLCBsZXZlbHNEZWVwIC0gMSlcbiAgICAgICAgICAgIC50aGVuKG5lc3RlZEZpbGVzID0+IHtcbiAgICAgICAgICAgICAgZW50cmllcyA9IGVudHJpZXMuY29uY2F0KG5lc3RlZEZpbGVzKTtcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZW50cmllcy5wdXNoKGZ1bGxQYXRoKTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIC8vIFRoaXMgaXMgYSB2YWxpZCB1c2UgY2FzZSwgcGFydGljdWxhcmx5IGlmIHRoZSBmaWxlXG4gICAgICAgIC8vICBpcyBkZXBsb3llZCBieSBWb3J0ZXggdXNpbmcgc3ltbGlua3MsIGFuZCB0aGUgbW9kIGRvZXNcbiAgICAgICAgLy8gIG5vdCBleGlzdCB3aXRoaW4gdGhlIHN0YWdpbmcgZm9sZGVyLlxuICAgICAgICBsb2coJ2Vycm9yJywgJ01uQjI6IGludmFsaWQgc3ltbGluaycsIGVycik7XG4gICAgICAgIHJldHVybiAoZXJyLmNvZGUgPT09ICdFTk9FTlQnKVxuICAgICAgICAgID8gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgICA6IFByb21pc2UucmVqZWN0KGVycik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSlcbiAgLnRoZW4oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKGVudHJpZXMpKTtcbn1cbiJdfQ==